{% extends 'base.html' %}
{% block title %}Job Applications{% endblock %}
{% load static %}

{% block content %}
<div class="container-fluid">
    <div class="card border-dark">
        <div class="card-header bg-primary text-white border-dark d-flex flex-column flex-md-row justify-content-between align-items-center">
            <div class="d-flex flex-column flex-md-row align-items-center mb-2 mb-md-0">
                <h5 class="card-title mb-0 me-md-3 mb-2 mb-md-0">
                    <i class="fas fa-file-alt me-2"></i>{{ page_title }}
                </h5>
                {% if perms.vacancy_app.add_jobapplication %}
                <div class="d-flex align-items-center gap-2">
                    <a href="{% url 'vacancy_app:application_create' %}" class="btn btn-success btn-sm">
                        <i class="fas fa-plus me-1"></i>New Application
                    </a>
                </div>
                {% endif %}
            </div>
            <div class="text-white text-center text-md-end">
                <small><i class="fas fa-info-circle me-1"></i>Total Applications: <span
                        id="total-applications">0</span></small>
            </div>
        </div>
        <div class="card-body p-0">
            <!-- Filter Section -->
            {% if vacancy_filter %}
            <div class="p-3 bg-light border-bottom">
                <div class="row align-items-center">
                    <div class="col-md-6">
                        <span class="text-muted">
                            <i class="fas fa-filter me-1"></i>
                            Filtered by vacancy
                        </span>
                    </div>
                    <div class="col-md-6 text-end">
                        <a href="{% url 'vacancy_app:application_list' %}" class="btn btn-outline-secondary btn-sm">
                            <i class="fas fa-times me-1"></i>Clear Filter
                        </a>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- DataTable -->
            <div class="table-responsive">
                <table id="applications-table" class="table table-hover table-striped table-bordered border-dark"
                    style="width:100%; margin:0;">
                    <thead class="table-primary border-dark">
                        <tr>
                            <th>Applicant Name</th>
                            <th>Vacancy</th>
                            <th>Email</th>
                            <th>Phone</th>
                            <th>Cover Letter</th>
                            <th>Resume</th>
                            <th>Status</th>
                            <th>Applied Date</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody class="table-light border-dark">
                        <!-- Data will be loaded via AJAX -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Quick Status Modal -->
<div class="modal fade" id="quickStatusModal" tabindex="-1" aria-labelledby="quickStatusModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-sm">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title" id="quickStatusModalLabel">
                    <i class="fas fa-sync me-2"></i>Change Status
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center">
                <div class="quick-status-options">
                    <div class="row g-2">
                        <div class="col-6">
                            <button class="btn status-option-btn status-pending w-100 h-100 p-3" data-status="pending">
                                <i class="fas fa-clock fa-2x mb-2"></i><br>
                                <span>Pending</span>
                            </button>
                        </div>
                        <div class="col-6">
                            <button class="btn status-option-btn status-reviewed w-100 h-100 p-3" data-status="reviewed">
                                <i class="fas fa-eye fa-2x mb-2"></i><br>
                                <span>Reviewed</span>
                            </button>
                        </div>
                        <div class="col-6">
                            <button class="btn status-option-btn status-accepted w-100 h-100 p-3" data-status="accepted">
                                <i class="fas fa-check fa-2x mb-2"></i><br>
                                <span>Accepted</span>
                            </button>
                        </div>
                        <div class="col-6">
                            <button class="btn status-option-btn status-rejected w-100 h-100 p-3" data-status="rejected">
                                <i class="fas fa-times fa-2x mb-2"></i><br>
                                <span>Rejected</span>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="mt-3">
                    <small class="text-muted">Click any status to apply immediately</small>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<!-- DataTables CSS -->
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.13.4/css/dataTables.bootstrap5.min.css">
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/buttons/2.3.6/css/buttons.bootstrap5.min.css">
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/responsive/2.4.1/css/responsive.bootstrap5.min.css">
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/colreorder/1.6.2/css/colReorder.bootstrap5.min.css">
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/fixedheader/3.3.2/css/fixedHeader.bootstrap5.min.css">

<style>
    /* Base table styles */
    #applications-table {
        border: 2px solid #000 !important;
        border-collapse: separate !important;
        background-color: white;
    }

    #applications-table th,
    #applications-table td {
        border: 1px solid #000 !important;
        vertical-align: middle !important;
        padding: 8px 6px !important;
        font-size: 0.85rem;
    }

    #applications-table thead th {
        border-bottom: 2px solid #000 !important;
        background-color: #b8d4ff !important;
        font-weight: 600;
        font-size: 0.8rem;
        text-align: center;
    }

    /* Enhanced status badges */
    .status-badge {
        display: inline-block;
        padding: 0.35rem 0.65rem;
        font-size: 0.75rem;
        font-weight: 500;
        line-height: 1;
        text-align: center;
        white-space: nowrap;
        vertical-align: baseline;
        border-radius: 0.375rem;
        transition: all 0.3s ease;
        border: 1px solid transparent;
        min-width: 100px;
    }

    .status-badge:hover {
        transform: scale(1.05);
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }

    .status-editable {
        cursor: pointer !important;
    }

    /* Status colors */
    .status-pending { 
        background-color: #ffc107 !important; 
        color: #000 !important; 
        border-color: #d39e00 !important;
    }
    .status-reviewed { 
        background-color: #0dcaf0 !important; 
        color: #000 !important; 
        border-color: #0aa2c0 !important;
    }
    .status-accepted { 
        background-color: #198754 !important; 
        color: #fff !important; 
        border-color: #146c43 !important;
    }
    .status-rejected { 
        background-color: #dc3545 !important; 
        color: #fff !important; 
        border-color: #b02a37 !important;
    }

    /* Description tooltip */
    .description-tooltip {
        cursor: pointer;
        color: #007bff;
        padding: 2px 4px;
        border-radius: 3px;
        transition: background-color 0.2s;
        font-size: 0.8rem;
    }

    .description-tooltip:hover {
        background-color: #f8f9fa;
        text-decoration: underline;
    }

    /* Dropdown styles */
    .status-dropdown {
        min-width: 140px;
        font-size: 0.8rem;
    }

    .status-dropdown-menu {
        min-width: 160px;
    }

    .status-dropdown-item {
        cursor: pointer;
        padding: 0.5rem 1rem;
        display: flex;
        align-items: center;
        justify-content: space-between;
        transition: all 0.2s;
    }

    .status-dropdown-item:hover {
        background-color: #f8f9fa;
    }

    .status-dropdown-item.active {
        background-color: #e7f1ff;
        font-weight: 600;
    }

    /* Button styles */
    .btn-group-sm .btn {
        padding: 0.2rem 0.4rem;
        font-size: 0.75rem;
    }

    .dt-buttons .btn {
        font-size: 0.75rem;
        margin: 1px;
    }

    /* Loading overlay */
    .overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255, 255, 255, 0.8);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
    }

    /* Quick status modal buttons */
    .status-option-btn {
        border: 2px solid transparent;
        transition: all 0.3s ease;
        border-radius: 8px;
    }

    .status-option-btn:hover {
        transform: translateY(-2px);
        border-color: #000;
    }

    /* Status change animation */
    @keyframes statusChange {
        0% { transform: scale(1); }
        50% { transform: scale(1.1); }
        100% { transform: scale(1); }
    }

    .status-changing {
        animation: statusChange 0.5s ease;
    }

    /* Real-time status updates */
    .status-updating {
        opacity: 0.7;
        pointer-events: none;
    }

    /* Mobile action buttons */
    .mobile-actions {
        display: none;
    }

    /* Responsive Design */
    
    /* Large devices (desktops, 1200px and up) */
    @media (min-width: 1200px) {
        #applications-table th,
        #applications-table td {
            padding: 8px 6px !important;
            font-size: 0.85rem;
        }
        
        .card-header {
            padding: 12px 20px;
        }
    }

    /* Medium devices (tablets, 992px to 1199px) */
    @media (max-width: 1199px) and (min-width: 992px) {
        #applications-table th,
        #applications-table td {
            padding: 6px 4px !important;
            font-size: 0.8rem;
        }
        
        .status-badge {
            min-width: 90px;
            font-size: 0.7rem;
            padding: 0.3rem 0.5rem;
        }
        
        .card-header {
            padding: 10px 15px;
        }
    }

    /* Small devices (landscape phones, 768px to 991px) */
    @media (max-width: 991px) and (min-width: 768px) {
        #applications-table th,
        #applications-table td {
            padding: 5px 3px !important;
            font-size: 0.75rem;
        }
        
        .status-badge {
            min-width: 80px;
            font-size: 0.65rem;
            padding: 0.25rem 0.4rem;
        }
        
        .desktop-actions {
            display: none;
        }
        
        .mobile-actions {
            display: flex;
            justify-content: center;
            gap: 2px;
        }
        
        .mobile-actions .btn {
            padding: 0.1rem 0.25rem;
            font-size: 0.6rem;
        }
        
        .card-header {
            padding: 8px 12px;
        }
        
        .dataTables_wrapper .dt-buttons {
            text-align: center;
            margin-bottom: 10px;
        }
        
        .dataTables_wrapper .dt-buttons .btn {
            margin: 2px;
            font-size: 0.7rem;
        }
    }

    /* Extra small devices (portrait phones, less than 768px) */
    @media (max-width: 767px) {
        #applications-table th,
        #applications-table td {
            padding: 4px 2px !important;
            font-size: 0.7rem;
        }
        
        .status-badge {
            min-width: 70px;
            font-size: 0.6rem;
            padding: 0.2rem 0.3rem;
        }
        
        .desktop-actions {
            display: none;
        }
        
        .mobile-actions {
            display: flex;
            justify-content: center;
            gap: 2px;
        }
        
        .mobile-actions .btn {
            padding: 0.1rem 0.25rem;
            font-size: 0.6rem;
        }
        
        .card-header {
            padding: 6px 10px;
        }
        
        .table-responsive {
            font-size: 0.75rem;
        }
        
        .dataTables_filter input {
            width: 100% !important;
        }
        
        .dataTables_wrapper .dt-buttons {
            text-align: center;
        }
        
        .dt-buttons .btn {
            display: block;
            width: 100%;
            margin: 1px 0;
            font-size: 0.7rem;
        }
        
        /* DataTables responsive child row styling */
        .dtr-details {
            width: 100% !important;
        }
        
        .dtr-details li {
            border-bottom: 1px solid #eee;
            padding: 6px 0;
        }
        
        .dtr-details .dtr-title {
            font-weight: 600;
            min-width: 80px;
            display: inline-block;
            font-size: 0.75rem;
        }
    }

    /* Very small devices (less than 576px) */
    @media (max-width: 575px) {
        #applications-table th,
        #applications-table td {
            padding: 3px 1px !important;
            font-size: 0.65rem;
        }
        
        .status-badge {
            min-width: 60px;
            font-size: 0.55rem;
            padding: 0.15rem 0.25rem;
        }
        
        .container-fluid {
            padding-left: 5px;
            padding-right: 5px;
        }
        
        .card-body {
            padding: 5px;
        }
        
        .quick-status-options .row {
            flex-direction: column;
        }
        
        .quick-status-options .col-6 {
            width: 100%;
            margin-bottom: 8px;
        }
        
        .status-option-btn {
            padding: 1rem !important;
        }
    }

    /* Print styles */
    @media print {
        .card-header {
            background-color: #ffffff !important;
            color: #000000 !important;
        }
        
        .btn, .dataTables_filter, .dataTables_length, .dt-buttons {
            display: none !important;
        }
        
        #applications-table {
            font-size: 10px;
        }
    }

    /* High contrast mode support */
    @media (prefers-contrast: high) {
        #applications-table th,
        #applications-table td {
            border: 2px solid #000 !important;
        }
        
        .status-badge {
            border: 2px solid #000;
        }
    }

    /* Reduced motion support */
    @media (prefers-reduced-motion: reduce) {
        .status-badge,
        .status-option-btn,
        .btn {
            transition: none;
        }
        
        .status-changing {
            animation: none;
        }
    }

    /* Dark mode support */
    @media (prefers-color-scheme: dark) {
        .table-light {
            background-color: #212529 !important;
            color: #f8f9fa !important;
        }
        
        .table-striped tbody tr:nth-of-type(odd) {
            background-color: rgba(255, 255, 255, 0.05) !important;
        }
    }

    /* Custom scrollbar for table */
    .table-responsive::-webkit-scrollbar {
        height: 6px;
    }

    .table-responsive::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 8px;
    }

    .table-responsive::-webkit-scrollbar-thumb {
        background: #c1c1c1;
        border-radius: 8px;
    }

    /* Loading states */
    .dataTables_processing {
        background: linear-gradient(90deg, transparent, rgba(78, 115, 223, 0.1), transparent) !important;
        background-size: 200% 100% !important;
        animation: loading 1.5s infinite !important;
    }

    @keyframes loading {
        0% { background-position: 200% 0; }
        100% { background-position: -200% 0; }
    }

    /* Column visibility dropdown */
    .dt-button-collection {
        max-height: 400px;
        overflow-y: auto;
    }

    /* Fixed header */
    table.dataTable thead tr th {
        border-bottom: 2px solid #000 !important;
    }

    /* Responsive text truncation */
    .table-responsive td {
        max-width: 150px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    /* Button group styling */
    .dt-buttons {
        margin-bottom: 10px;
    }

    /* Status indicator */
    .status-indicator {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        display: inline-block;
        margin-right: 6px;
    }

    .status-active { background-color: #198754; }
    .status-inactive { background-color: #6c757d; }
    .status-draft { background-color: #ffc107; }
</style>
{% endblock %}

{% block extra_js %}
<!-- DataTables JS -->
<script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.4/js/dataTables.bootstrap5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.3.6/js/dataTables.buttons.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.3.6/js/buttons.bootstrap5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.3.6/js/buttons.html5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.3.6/js/buttons.print.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.3.6/js/buttons.colVis.min.js"></script>
<script src="https://cdn.datatables.net/responsive/2.4.1/js/dataTables.responsive.min.js"></script>
<script src="https://cdn.datatables.net/responsive/2.4.1/js/responsive.bootstrap5.min.js"></script>
<script src="https://cdn.datatables.net/colreorder/1.6.2/js/dataTables.colReorder.min.js"></script>
<script src="https://cdn.datatables.net/fixedheader/3.3.2/js/dataTables.fixedHeader.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/pdfmake.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/vfs_fonts.js"></script>

<script>
    $(document).ready(function () {
        var table = $('#applications-table').DataTable({
            "processing": true,
            "serverSide": true,
            "ajax": {
                "url": "{% url 'vacancy_app:application_datatables' %}",
                "type": "GET",
                "dataType": "json",
                "data": function (d) {
                    // Add vacancy filter to AJAX data
                    {% if vacancy_filter %}
                    d.vacancy = "{{ vacancy_filter }}";
                    {% endif %}
                },
                "dataSrc": function (json) {
                    // Update total applications count
                    $('#total-applications').text(json.recordsTotal);
                    return json.data;
                },
                "error": function (xhr, error, code) {
                    console.log('DataTables Error:', error);
                    Swal.fire({
                        icon: 'error',
                        title: 'Data Loading Error',
                        text: 'Unable to load application data. Please try again.',
                        timer: 3000
                    });
                }
            },
            "columns": [
                {
                    "data": "full_name",
                    "name": "full_name",
                    "className": "text-left",
                    "responsivePriority": 1
                },
                {
                    "data": "vacancy",
                    "name": "vacancy__title",
                    "className": "text-center",
                    "responsivePriority": 3
                },
                {
                    "data": "email",
                    "name": "email",
                    "className": "text-center",
                    "responsivePriority": 2
                },
                {
                    "data": "phone",
                    "name": "phone",
                    "className": "text-center",
                    "responsivePriority": 4
                },
                {
                    "data": "cover_letter",
                    "name": "cover_letter",
                    "className": "text-center",
                    "orderable": false,
                    "responsivePriority": 7
                },
                {
                    "data": "resume",
                    "name": "resume",
                    "className": "text-center",
                    "orderable": false,
                    "responsivePriority": 8
                },
                {
                    "data": "status",
                    "name": "status",
                    "className": "text-center",
                    "orderable": false,
                    "responsivePriority": 5
                },
                {
                    "data": "applied_at",
                    "name": "applied_at",
                    "className": "text-center",
                    "responsivePriority": 6
                },
                {
                    "data": "actions",
                    "name": "actions",
                    "className": "text-center",
                    "orderable": false,
                    "searchable": false,
                    "responsivePriority": 1
                }
            ],
            "order": [[7, 'desc']],
            "pageLength": 10,
            "lengthMenu": [[10, 25, 50, 100], [10, 25, 50, 100]],
            "responsive": {
                details: {
                    display: $.fn.dataTable.Responsive.display.modal({
                        header: function (row) {
                            var data = row.data();
                            return 'Application Details: ' + data.full_name;
                        }
                    }),
                    renderer: function (api, rowIdx, columns) {
                        var data = $.map(columns, function (col, i) {
                            return '<tr>' +
                                '<td class="fw-bold">' + col.title + ':' + '</td> ' +
                                '<td>' + (col.data || '') + '</td>' +
                                '</tr>';
                        }).join('');

                        return $('<table class="table table-sm"/>').append(data);
                    }
                },
                breakpoints: [
                    { name: 'desktop', width: Infinity },
                    { name: 'tablet', width: 1200 },
                    { name: 'mobile', width: 768 }
                ]
            },
            "dom": '<"row"<"col-sm-12 col-md-6"B><"col-sm-12 col-md-6"f>>' +
                   '<"row"<"col-sm-12"tr>>' +
                   '<"row"<"col-sm-12 col-md-5"i><"col-sm-12 col-md-7"p>>',
            "buttons": [
                {
                    extend: 'colvis',
                    text: '<i class="fas fa-columns"></i> Columns',
                    className: 'btn btn-secondary btn-sm',
                    columns: ':not(:last-child)',
                    collectionLayout: 'fixed two-column'
                },
                {
                    extend: 'copy',
                    text: '<i class="fas fa-copy"></i> Copy',
                    className: 'btn btn-secondary btn-sm',
                    exportOptions: {
                        columns: ':visible:not(:last-child)'
                    }
                },
                {
                    extend: 'excel',
                    text: '<i class="fas fa-file-excel"></i> Excel',
                    className: 'btn btn-success btn-sm',
                    exportOptions: {
                        columns: ':visible:not(:last-child)'
                    },
                    filename: 'job_applications_' + new Date().toISOString().slice(0, 10)
                },
                {
                    extend: 'pdf',
                    text: '<i class="fas fa-file-pdf"></i> PDF',
                    className: 'btn btn-danger btn-sm',
                    exportOptions: {
                        columns: ':visible:not(:last-child)'
                    },
                    filename: 'job_applications_' + new Date().toISOString().slice(0, 10),
                    orientation: 'landscape',
                    pageSize: 'A4'
                },
                {
                    extend: 'print',
                    text: '<i class="fas fa-print"></i> Print',
                    className: 'btn btn-info btn-sm',
                    exportOptions: {
                        columns: ':visible:not(:last-child)'
                    },
                    customize: function (win) {
                        $(win.document.body).find('table').addClass('display').css('font-size', '10px');
                        $(win.document.body).find('tr:nth-child(odd) td').css('background-color', '#f9f9f9');
                        $(win.document.body).find('h1').text('Job Applications - ' + new Date().toLocaleDateString());
                    }
                },
                {
                    text: '<i class="fas fa-sync-alt"></i> Refresh',
                    className: 'btn btn-warning btn-sm',
                    action: function (e, dt, node, config) {
                        table.ajax.reload(null, false);
                        Swal.fire({
                            icon: 'success',
                            title: 'Refreshed',
                            text: 'Data has been refreshed successfully',
                            timer: 1500,
                            showConfirmButton: false
                        });
                    }
                }
            ],
            "colReorder": true,
            "fixedHeader": true,
            "language": {
                "search": "Search:",
                "lengthMenu": "Show _MENU_ entries",
                "info": "Showing _START_ to _END_ of _TOTAL_ entries",
                "infoEmpty": "Showing 0 to 0 of 0 entries",
                "infoFiltered": "(filtered from _MAX_ total entries)",
                "zeroRecords": "No matching applications found",
                "emptyTable": "No application data available",
                "processing": '<i class="fas fa-spinner fa-spin"></i> Loading...',
                "paginate": {
                    "first": "First",
                    "last": "Last",
                    "next": "Next",
                    "previous": "Previous"
                }
            },
            "initComplete": function (settings, json) {
                $('.dataTables_filter input')
                    .addClass('form-control form-control-sm')
                    .attr('placeholder', 'Search in name, email, phone, vacancy...')
                    .css('width', '300px')
                    .wrap('<div class="input-group"></div>')
                    .before('<span class="input-group-text"><i class="fas fa-search"></i></span>');

                $('.dataTables_length select').addClass('form-control form-control-sm');

                if (json && json.recordsTotal) {
                    $('#total-applications').text(json.recordsTotal);
                }
            },
            "drawCallback": function (settings) {
                initializeTableInteractions();
            }
        });

        // Global variables for status management
        var currentApplicationId = null;
        var currentStatusElement = null;

        function initializeTableInteractions() {
            // Initialize tooltips
            $('[data-bs-toggle="tooltip"]').tooltip();

            // Cover letter click functionality
            $('.description-tooltip').off('click').on('click', function (e) {
                e.preventDefault();
                var description = $(this).data('description') || 'No cover letter available';
                Swal.fire({
                    title: 'Cover Letter',
                    html: '<div style="text-align: left; max-height: 400px; overflow-y: auto; padding: 15px; background: #f8f9fa; border-radius: 5px; border: 1px solid #dee2e6; white-space: pre-wrap;">' +
                        description + '</div>',
                    icon: 'info',
                    confirmButtonText: 'Close',
                    width: '700px'
                });
            });

            // Enhanced Status Dropdown Click
            $('.status-dropdown-toggle').off('click').on('click', function (e) {
                e.stopPropagation();
                currentApplicationId = $(this).data('application-id');
                currentStatusElement = $(this).closest('.status-dropdown').find('.status-badge');
                
                // Show quick status modal
                $('#quickStatusModal').modal('show');
            });

            // Status dropdown item click
            $('.status-dropdown-item').off('click').on('click', function (e) {
                e.preventDefault();
                var applicationId = $(this).data('application-id');
                var newStatus = $(this).data('status');
                var badgeElement = $(this).closest('.status-dropdown').find('.status-badge');
                
                changeApplicationStatus(applicationId, newStatus, badgeElement);
            });

            // Quick Status Modal Button Click
            $('.status-option-btn').off('click').on('click', function () {
                var newStatus = $(this).data('status');
                $('#quickStatusModal').modal('hide');
                
                if (currentApplicationId && currentStatusElement) {
                    changeApplicationStatus(currentApplicationId, newStatus, currentStatusElement);
                }
            });

            // Double-click status for quick change
            $('.status-badge.status-editable').off('dblclick').on('dblclick', function (e) {
                e.stopPropagation();
                var applicationId = $(this).data('application-id');
                var currentStatus = $(this).data('current-status');
                var badge = $(this);

                // Quick status cycle
                var statusOrder = ['pending', 'reviewed', 'accepted', 'rejected'];
                var currentIndex = statusOrder.indexOf(currentStatus);
                var newIndex = (currentIndex + 1) % statusOrder.length;
                var newStatus = statusOrder[newIndex];

                changeApplicationStatus(applicationId, newStatus, badge);
            });
        }

        function changeApplicationStatus(applicationId, newStatus, badgeElement) {
            // Show confirmation for certain status changes
            if (newStatus === 'rejected') {
                Swal.fire({
                    title: 'Reject Application?',
                    text: 'This action cannot be undone. The applicant will be notified.',
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonText: 'Yes, Reject',
                    cancelButtonText: 'Cancel',
                    reverseButtons: true,
                    confirmButtonColor: '#dc3545'
                }).then((result) => {
                    if (result.isConfirmed) {
                        performStatusChange(applicationId, newStatus, badgeElement);
                    }
                });
            } else if (newStatus === 'accepted') {
                Swal.fire({
                    title: 'Accept Application?',
                    text: 'This applicant will be moved to the accepted list.',
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonText: 'Yes, Accept',
                    cancelButtonText: 'Cancel',
                    reverseButtons: true,
                    confirmButtonColor: '#198754'
                }).then((result) => {
                    if (result.isConfirmed) {
                        performStatusChange(applicationId, newStatus, badgeElement);
                    }
                });
            } else {
                performStatusChange(applicationId, newStatus, badgeElement);
            }
        }

        function performStatusChange(applicationId, newStatus, badgeElement) {
            // Use the existing toggle_application_status URL pattern
            var url = "{% url 'vacancy_app:toggle_application_status' 0 %}".replace('0', applicationId);
            
            $.ajax({
                url: url,
                type: 'POST',
                data: {
                    'status': newStatus,
                    'csrfmiddlewaretoken': '{{ csrf_token }}'
                },
                beforeSend: function () {
                    // Show loading state
                    badgeElement.addClass('status-updating');
                    badgeElement.html('<i class="fas fa-spinner fa-spin me-1"></i>Updating...');
                },
                success: function (response) {
                    if (response.success) {
                        // Update the badge with animation
                        updateStatusBadge(badgeElement, newStatus, response.new_status_display);
                        
                        // Show success message
                        Swal.fire({
                            icon: 'success',
                            title: 'Status Updated',
                            text: response.message,
                            timer: 1500,
                            showConfirmButton: false
                        });

                        // Update the dropdown to reflect current status
                        updateStatusDropdown(applicationId, newStatus);
                        
                    } else {
                        Swal.fire({
                            icon: 'error',
                            title: 'Error',
                            text: response.error || 'Failed to update status'
                        });
                        // Restore original state
                        table.ajax.reload(null, false);
                    }
                },
                error: function (xhr, status, error) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: 'Failed to update status. Please try again.'
                    });
                    // Restore original state
                    table.ajax.reload(null, false);
                },
                complete: function () {
                    badgeElement.removeClass('status-updating');
                }
            });
        }

        function updateStatusBadge(badgeElement, newStatus, displayText) {
            // Remove all status classes
            badgeElement.removeClass('status-pending status-reviewed status-accepted status-rejected');
            
            // Add new status class with animation
            badgeElement.addClass('status-' + newStatus + ' status-changing');
            
            // Update text and icon
            var icons = {
                'pending': 'fa-clock',
                'reviewed': 'fa-eye', 
                'accepted': 'fa-check',
                'rejected': 'fa-times'
            };
            
            badgeElement.html(`<i class="fas ${icons[newStatus]} me-1"></i>${displayText}`);
            badgeElement.data('current-status', newStatus);
            
            // Remove animation class after animation completes
            setTimeout(function() {
                badgeElement.removeClass('status-changing');
            }, 500);
        }

        function updateStatusDropdown(applicationId, newStatus) {
            // Update the dropdown menu to show current status
            $('.status-dropdown-item[data-application-id="' + applicationId + '"]').removeClass('active');
            $('.status-dropdown-item[data-application-id="' + applicationId + '"][data-status="' + newStatus + '"]').addClass('active');
        }

        // Add loading overlay
        $('#applications-table').on('processing.dt', function (e, settings, processing) {
            if (processing) {
                $(this).closest('.card').append('<div class="overlay"><i class="fas fa-3x fa-sync-alt fa-spin text-primary"></i></div>');
            } else {
                $(this).closest('.card').find('.overlay').remove();
            }
        });

        // Style buttons container
        $('.dt-buttons').addClass('btn-group flex-wrap gap-1 mb-2');
        $('.dt-button').addClass('btn-sm');

        // Row click functionality
        $('#applications-table tbody').on('click', 'tr', function () {
            $(this).toggleClass('table-active');
        });

        // Close modals on escape key
        $(document).on('keydown', function (e) {
            if (e.key === 'Escape') {
                $('#quickStatusModal').modal('hide');
            }
        });

        // Auto-refresh data every 30 seconds (optional)
        setInterval(function() {
            table.ajax.reload(null, false);
        }, 30000);
    });
</script>
{% endblock %}