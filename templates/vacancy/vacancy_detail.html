{% extends 'base.html' %}
{% block title %}Vacancy Detail - {{ vacancy.title }}{% endblock %}
{% load static %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row justify-content-center">
        <div class="col-xxl-10 col-xl-12 col-lg-12">
            <!-- Header Section -->
            <div class="card shadow-sm border-0 mb-4">
                <div class="card-header bg-gradient-primary text-white py-4">
                    <div class="d-flex flex-column flex-md-row justify-content-between align-items-center">
                        <div class="flex-grow-1 text-center text-md-start mb-3 mb-md-0">
                            <h1 class="h2 mb-2 text-white fw-bold">{{ vacancy.title }}</h1>
                            <div class="d-flex flex-wrap gap-3 align-items-center justify-content-center justify-content-md-start">
                                <span class="badge bg-light text-dark fs-6">
                                    <i class="fas fa-briefcase me-2"></i>{{ vacancy.get_job_type_display }}
                                </span>
                                <span class="badge bg-light text-dark fs-6">
                                    <i class="fas fa-money-bill-wave me-2"></i>Rs {{ vacancy.salary }}
                                </span>
                                <span class="badge bg-light text-dark fs-6">
                                    <i class="fas fa-map-marker-alt me-2"></i>{{ vacancy.address }}
                                </span>
                                {% if vacancy.is_expired %}
                                <span class="badge bg-danger fs-6">Expired</span>
                                {% else %}
                                <span class="badge bg-success fs-6">Active</span>
                                {% endif %}
                            </div>
                        </div>
                        {% if vacancy.image %}
                        <div class="ms-md-4 mt-2 mt-md-0">
                            <img src="{{ vacancy.image.url }}" alt="{{ vacancy.title }}" class="img-fluid rounded-3"
                                style="max-height: 120px;">
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <div class="row">
                <!-- Main Content -->
                <div class="col-lg-8">
                    <!-- Job Description -->
                    <div class="card shadow-sm border-0 mb-4">
                        <div class="card-header bg-light py-3">
                            <h5 class="mb-0">
                                <i class="fas fa-file-alt me-2 text-primary"></i>
                                Job Description
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="job-description">
                                {{ vacancy.description|safe }}
                            </div>
                        </div>
                    </div>

                    <!-- Required Skills -->
                    <div class="card shadow-sm border-0 mb-4">
                        <div class="card-header bg-light py-3">
                            <h5 class="mb-0">
                                <i class="fas fa-tools me-2 text-warning"></i>
                                Required Skills
                            </h5>
                        </div>
                        <div class="card-body">
                            {% if vacancy.skills %}
                            <div class="d-flex flex-wrap gap-2">
                                {% for skill in vacancy.get_skills_list %}
                                <span class="badge bg-primary fs-6 py-2 px-3 skill-badge">
                                    <i class="fas fa-check-circle me-1"></i>
                                    {{ skill }}
                                </span>
                                {% empty %}
                                <div class="text-center text-muted w-100 py-3">
                                    <i class="fas fa-exclamation-circle fa-2x mb-2"></i>
                                    <p class="mb-0">No skills specified</p>
                                </div>
                                {% endfor %}
                            </div>
                            {% if not vacancy.get_skills_list and vacancy.skills.strip %}
                            <div class="mt-3">
                                <h6 class="text-muted mb-2">Skills Required:</h6>
                                <p class="mb-0 text-muted">{{ vacancy.skills }}</p>
                            </div>
                            {% endif %}
                            {% else %}
                            <div class="text-center text-muted py-3">
                                <i class="fas fa-exclamation-circle fa-2x mb-2"></i>
                                <p class="mb-0">No specific skills mentioned</p>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Sidebar -->
                <div class="col-lg-4">
                    <!-- Job Summary -->
                    <div class="card shadow-sm border-0 mb-4">
                        <div class="card-header bg-light py-3">
                            <h5 class="mb-0">
                                <i class="fas fa-info-circle me-2 text-info"></i>
                                Job Summary
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <strong><i class="fas fa-calendar-plus me-2 text-success"></i>Posted Date:</strong>
                                <p class="mb-0">{{ vacancy.created_at|date:"M d, Y" }}</p>
                            </div>
                            <div class="mb-3">
                                <strong><i class="fas fa-calendar-times me-2 text-danger"></i>Application Deadline:</strong>
                                <p class="mb-0">{{ vacancy.expired_date|date:"M d, Y" }}</p>
                                {% if vacancy.is_expired %}
                                <small class="text-danger"><i class="fas fa-exclamation-triangle me-1"></i>This vacancy has expired</small>
                                {% else %}
                                <small class="text-success"><i class="fas fa-clock me-1"></i>Active for applications</small>
                                {% endif %}
                            </div>
                            <div class="mb-3">
                                <strong><i class="fas fa-clock me-2 text-primary"></i>Job Type:</strong>
                                <p class="mb-0">{{ vacancy.get_job_type_display }}</p>
                            </div>
                            <div class="mb-3">
                                <strong><i class="fas fa-money-bill-wave me-2 text-success"></i>Salary:</strong>
                                <p class="mb-0">Rs {{ vacancy.salary }}</p>
                            </div>
                            <div class="mb-3">
                                <strong><i class="fas fa-map-marker-alt me-2 text-warning"></i>Location:</strong>
                                <p class="mb-0">{{ vacancy.address }}</p>
                            </div>
                            <div class="mb-3">
                                <strong><i class="fas fa-tools me-2 text-info"></i>Skills:</strong>
                                <div class="mt-1">
                                    {% if vacancy.get_skills_list %}
                                    {% for skill in vacancy.get_skills_list|slice:":3" %}
                                    <span class="badge bg-secondary badge-sm me-1 mb-1">{{ skill }}</span>
                                    {% endfor %}
                                    {% with skills=vacancy.get_skills_list %}
                                    {% if skills|length > 3 %}
                                    <span class="badge bg-light text-dark badge-sm">+{{ skills|length|add:"-3" }} more</span>
                                    {% endif %}
                                    {% endwith %}
                                    {% else %}
                                    <span class="text-muted">Not specified</span>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="mb-0">
                                <strong><i class="fas fa-toggle-on me-2 text-info"></i>Status:</strong>
                                <p class="mb-0">
                                    {% if vacancy.status == 'active' %}
                                    <span class="badge bg-success">Active</span>
                                    {% elif vacancy.status == 'inactive' %}
                                    <span class="badge bg-secondary">Inactive</span>
                                    {% else %}
                                    <span class="badge bg-warning">Draft</span>
                                    {% endif %}
                                </p>
                            </div>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="card shadow-sm border-0">
                        <div class="card-body">
                            {% if not vacancy.is_expired and vacancy.status == 'active' %}
                            <button class="btn btn-success btn-lg w-100 mb-3" data-bs-toggle="modal"
                                data-bs-target="#applyModal">
                                <i class="fas fa-paper-plane me-2"></i>
                                Apply Now
                            </button>
                            {% elif vacancy.is_expired %}
                            <button class="btn btn-secondary btn-lg w-100 mb-3" disabled>
                                <i class="fas fa-clock me-2"></i>
                                Application Closed
                            </button>
                            {% elif vacancy.status != 'active' %}
                            <button class="btn btn-warning btn-lg w-100 mb-3" disabled>
                                <i class="fas fa-pause-circle me-2"></i>
                                Not Accepting Applications
                            </button>
                            {% endif %}

                            <div class="d-grid gap-2">
                                <a href="{% url 'vacancy_app:vacancy_list' %}" class="btn btn-outline-primary">
                                    <i class="fas fa-list me-2"></i>
                                    View All Jobs
                                </a>
                                {% if user.is_authenticated and user.is_staff %}
                                <a href="{% url 'vacancy_app:vacancy_edit' vacancy.id %}"
                                    class="btn btn-outline-warning">
                                    <i class="fas fa-edit me-2"></i>
                                    Edit Vacancy
                                </a>
                                <a href="{% url 'vacancy_app:vacancy_delete' vacancy.id %}"
                                    class="btn btn-outline-danger">
                                    <i class="fas fa-trash me-2"></i>
                                    Delete Vacancy
                                </a>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <!-- Quick Stats -->
                    {% if user.is_authenticated and user.is_staff %}
                    <div class="card shadow-sm border-0 mt-4">
                        <div class="card-header bg-light py-3">
                            <h5 class="mb-0">
                                <i class="fas fa-chart-bar me-2 text-success"></i>
                                Application Stats
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="row text-center">
                                <div class="col-4">
                                    <div class="stat-item">
                                        <div class="h4 mb-1 text-primary" id="stats-total">0</div>
                                        <small class="text-muted">Total</small>
                                    </div>
                                </div>
                                <div class="col-4">
                                    <div class="stat-item">
                                        <div class="h4 mb-1 text-warning" id="stats-pending">0</div>
                                        <small class="text-muted">Pending</small>
                                    </div>
                                </div>
                                <div class="col-4">
                                    <div class="stat-item">
                                        <div class="h4 mb-1 text-success" id="stats-accepted">0</div>
                                        <small class="text-muted">Accepted</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Apply Modal -->
{% if not vacancy.is_expired and vacancy.status == 'active' %}
<div class="modal fade" id="applyModal" tabindex="-1" aria-labelledby="applyModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-gradient-primary text-white">
                <h5 class="modal-title" id="applyModalLabel">
                    <i class="fas fa-paper-plane me-2"></i>
                    Apply for {{ vacancy.title }}
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                    aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="text-center py-4">
                    <i class="fas fa-briefcase fa-3x text-primary mb-3"></i>
                    <h4>Application Form</h4>
                    <p class="text-muted">Application functionality will be implemented here</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success">Submit Application</button>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Applications Section -->
{% if user.is_authenticated and user.is_staff %}
<div class="card shadow-sm border-0 mb-4">
    <div class="card-header bg-primary text-white border-dark d-flex flex-column flex-md-row justify-content-between align-items-center">
        <div class="d-flex flex-column flex-md-row align-items-center mb-2 mb-md-0">
            <h5 class="card-title mb-0 me-md-3 mb-2 mb-md-0">
                <i class="fas fa-users me-2"></i>Job Applications for {{ vacancy.title }}
            </h5>
        </div>
        <div class="text-white text-center text-md-end">
            <small><i class="fas fa-info-circle me-1"></i>Total Applications: <span
                    id="total-applications">0</span></small>
        </div>
    </div>
    <div class="card-body p-0">
        <!-- DataTable -->
        <div class="table-responsive">
            <table id="applications-table" class="table table-hover table-striped table-bordered border-dark"
                style="width:100%; margin:0;">
                <thead class="table-primary border-dark">
                    <tr>
                        <th>Applicant Name</th>
                        <th>Vacancy</th>
                        <th>Email</th>
                        <th>Phone</th>
                        <th>Cover Letter</th>
                        <th>Resume</th>
                        <th>Status</th>
                        <th>Applied Date</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody class="table-light border-dark">
                    <!-- Data will be loaded via AJAX -->
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endif %}

{% endblock %}

{% block extra_css %}
<!-- DataTables CSS -->
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.13.4/css/dataTables.bootstrap5.min.css">
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/buttons/2.3.6/css/buttons.bootstrap5.min.css">
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/responsive/2.4.1/css/responsive.bootstrap5.min.css">
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/colreorder/1.6.2/css/colReorder.bootstrap5.min.css">
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/fixedheader/3.3.2/css/fixedHeader.bootstrap5.min.css">

<style>
    .bg-gradient-primary {
        background: linear-gradient(135deg, #4361ee 0%, #3f37c9 100%) !important;
    }

    .card {
        border: none;
        border-radius: 15px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
    }

    .job-description {
        line-height: 1.7;
        font-size: 1.05rem;
    }

    .badge {
        font-weight: 500;
        border: none;
    }

    .skill-badge {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
        color: white;
        border: none;
        transition: all 0.3s ease;
    }

    .skill-badge:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }

    .btn {
        border-radius: 10px;
        font-weight: 600;
        transition: all 0.3s ease;
        border: none;
    }

    .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
    }

    /* Applications Table Styles */
    #applications-table {
        border: 2px solid #000 !important;
        border-collapse: separate !important;
        background-color: white;
    }

    #applications-table th,
    #applications-table td {
        border: 1px solid #000 !important;
        vertical-align: middle !important;
        padding: 8px 6px !important;
        font-size: 0.85rem;
    }

    #applications-table thead th {
        border-bottom: 2px solid #000 !important;
        background-color: #b8d4ff !important;
        font-weight: 600;
        font-size: 0.8rem;
        text-align: center;
    }

    .description-tooltip {
        cursor: pointer;
        color: #007bff;
        padding: 2px 4px;
        border-radius: 3px;
        transition: background-color 0.2s;
        font-size: 0.8rem;
    }

    .description-tooltip:hover {
        background-color: #f8f9fa;
        text-decoration: underline;
    }

    .status-badge {
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 0.75rem;
        padding: 0.35rem 0.65rem;
        border: none;
    }

    .status-badge:hover {
        transform: scale(1.05);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }

    .status-editable {
        cursor: pointer !important;
    }

    .overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255, 255, 255, 0.8);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
    }

    /* Status colors */
    .status-pending {
        background-color: #ffc107 !important;
        color: #000 !important;
    }

    .status-reviewed {
        background-color: #0dcaf0 !important;
        color: #000 !important;
    }

    .status-accepted {
        background-color: #198754 !important;
        color: #fff !important;
    }

    .status-rejected {
        background-color: #dc3545 !important;
        color: #fff !important;
    }

    /* Mobile action buttons */
    .mobile-actions {
        display: none;
    }

    /* Responsive adjustments */
    @media (max-width: 1200px) {
        #applications-table th,
        #applications-table td {
            padding: 6px 4px !important;
            font-size: 0.8rem;
        }
    }

    @media (max-width: 992px) {
        #applications-table th,
        #applications-table td {
            padding: 5px 3px !important;
            font-size: 0.75rem;
        }
        
        .dataTables_wrapper .dt-buttons {
            text-align: center;
            margin-bottom: 10px;
        }
        
        .dataTables_wrapper .dt-buttons .btn {
            margin: 2px;
            font-size: 0.7rem;
        }
    }

    @media (max-width: 768px) {
        #applications-table th,
        #applications-table td {
            padding: 4px 2px !important;
            font-size: 0.7rem;
        }
        
        .desktop-actions {
            display: none;
        }
        
        .mobile-actions {
            display: flex;
            justify-content: center;
            gap: 2px;
        }
        
        .mobile-actions .btn {
            padding: 0.1rem 0.25rem;
            font-size: 0.6rem;
        }
        
        /* DataTables responsive child row styling */
        .dtr-details {
            width: 100% !important;
        }
        
        .dtr-details li {
            border-bottom: 1px solid #eee;
            padding: 6px 0;
        }
        
        .dtr-details .dtr-title {
            font-weight: 600;
            min-width: 80px;
            display: inline-block;
            font-size: 0.75rem;
        }
    }

    @media (max-width: 576px) {
        .table-responsive {
            font-size: 0.75rem;
        }
        
        #applications-table th,
        #applications-table td {
            padding: 3px 1px !important;
        }
        
        .dataTables_filter input {
            width: 100% !important;
        }
        
        /* Stack buttons vertically on very small screens */
        .dt-buttons .btn {
            display: block;
            width: 100%;
            margin: 1px 0;
        }
    }

    /* Custom scrollbar for table */
    .table-responsive::-webkit-scrollbar {
        height: 6px;
    }

    .table-responsive::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 8px;
    }

    .table-responsive::-webkit-scrollbar-thumb {
        background: #c1c1c1;
        border-radius: 8px;
    }

    /* Loading states */
    .dataTables_processing {
        background: linear-gradient(90deg, transparent, rgba(78, 115, 223, 0.1), transparent) !important;
        background-size: 200% 100% !important;
        animation: loading 1.5s infinite !important;
    }

    @keyframes loading {
        0% { background-position: 200% 0; }
        100% { background-position: -200% 0; }
    }

    .stat-item .h4 {
        font-weight: 700;
    }

    /* Animation for skills */
    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .skill-badge {
        animation: fadeInUp 0.5s ease-out;
        animation-fill-mode: both;
    }

    .skill-badge:nth-child(1) { animation-delay: 0.1s; }
    .skill-badge:nth-child(2) { animation-delay: 0.2s; }
    .skill-badge:nth-child(3) { animation-delay: 0.3s; }
    .skill-badge:nth-child(4) { animation-delay: 0.4s; }
    .skill-badge:nth-child(5) { animation-delay: 0.5s; }
    .skill-badge:nth-child(6) { animation-delay: 0.6s; }
</style>
{% endblock %}

{% block extra_js %}
<!-- DataTables JS -->
<script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.4/js/dataTables.bootstrap5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.3.6/js/dataTables.buttons.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.3.6/js/buttons.bootstrap5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.3.6/js/buttons.html5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.3.6/js/buttons.print.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.3.6/js/buttons.colVis.min.js"></script>
<script src="https://cdn.datatables.net/responsive/2.4.1/js/dataTables.responsive.min.js"></script>
<script src="https://cdn.datatables.net/responsive/2.4.1/js/responsive.bootstrap5.min.js"></script>
<script src="https://cdn.datatables.net/colreorder/1.6.2/js/dataTables.colReorder.min.js"></script>
<script src="https://cdn.datatables.net/fixedheader/3.3.2/js/dataTables.fixedHeader.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/pdfmake.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/vfs_fonts.js"></script>

<script>
    $(document).ready(function () {
        // Add tooltips to skill badges
        $('.skill-badge').tooltip({
            title: 'Required skill',
            placement: 'top'
        });

        // Enhanced modal functionality
        $('#applyModal').on('show.bs.modal', function () {
            console.log('Application modal opened for: {{ vacancy.title }}');
        });

        // Initialize DataTable for applications (only for staff users)
        {% if user.is_authenticated and user.is_staff %}
        initializeApplicationsTable();
        {% endif %}
    });

    {% if user.is_authenticated and user.is_staff %}
    function initializeApplicationsTable() {
        var table = $('#applications-table').DataTable({
            "processing": true,
            "serverSide": true,
            "ajax": {
                "url": "{% url 'vacancy_app:application_datatables' %}",
                "type": "GET",
                "dataType": "json",
                "data": function (d) {
                    // Filter by current vacancy
                    d.vacancy = "{{ vacancy.id }}";
                },
                "dataSrc": function (json) {
                    // Update total applications count
                    $('#total-applications').text(json.recordsTotal);
                    $('#stats-total').text(json.recordsTotal);

                    // Update status counts if available
                    if (json.extra_data && json.extra_data.status_counts) {
                        $('#stats-pending').text(json.extra_data.status_counts.pending || 0);
                        $('#stats-accepted').text(json.extra_data.status_counts.accepted || 0);
                    }
                    return json.data;
                },
                "error": function (xhr, error, code) {
                    console.log('DataTables Error:', xhr, error, code);
                    Swal.fire({
                        icon: 'error',
                        title: 'Data Loading Error',
                        text: 'Unable to load application data. Please try again.',
                        timer: 3000
                    });
                }
            },
            "columns": [
                {
                    "data": "full_name",
                    "name": "full_name",
                    "className": "text-left",
                    "responsivePriority": 1
                },
                {
                    "data": "vacancy",
                    "name": "vacancy__title",
                    "className": "text-center",
                    "responsivePriority": 3
                },
                {
                    "data": "email",
                    "name": "email",
                    "className": "text-center",
                    "responsivePriority": 2
                },
                {
                    "data": "phone",
                    "name": "phone",
                    "className": "text-center",
                    "responsivePriority": 4
                },
                {
                    "data": "cover_letter",
                    "name": "cover_letter",
                    "className": "text-center",
                    "orderable": false,
                    "responsivePriority": 7
                },
                {
                    "data": "resume",
                    "name": "resume",
                    "className": "text-center",
                    "orderable": false,
                    "responsivePriority": 8
                },
                {
                    "data": "status",
                    "name": "status",
                    "className": "text-center",
                    "orderable": false,
                    "responsivePriority": 5
                },
                {
                    "data": "applied_at",
                    "name": "applied_at",
                    "className": "text-center",
                    "responsivePriority": 6
                },
                {
                    "data": "actions",
                    "name": "actions",
                    "className": "text-center",
                    "orderable": false,
                    "searchable": false,
                    "responsivePriority": 1,
                    "render": function(data, type, row) {
                        if (type === 'display') {
                            return `
                                <div class="desktop-actions">
                                    ${data || ''}
                                </div>
                                <div class="mobile-actions">
                                    ${data || ''}
                                </div>
                            `;
                        }
                        return data;
                    }
                }
            ],
            "order": [[7, 'desc']],
            "pageLength": 10,
            "lengthMenu": [[10, 25, 50, 100], [10, 25, 50, 100]],
            "responsive": {
                details: {
                    display: $.fn.dataTable.Responsive.display.modal({
                        header: function (row) {
                            var data = row.data();
                            return 'Application Details: ' + data.full_name;
                        }
                    }),
                    renderer: function (api, rowIdx, columns) {
                        var data = $.map(columns, function (col, i) {
                            return '<tr>' +
                                '<td class="fw-bold">' + col.title + ':' + '</td> ' +
                                '<td>' + (col.data || '') + '</td>' +
                                '</tr>';
                        }).join('');

                        return $('<table class="table table-sm"/>').append(data);
                    }
                },
                breakpoints: [
                    { name: 'desktop', width: Infinity },
                    { name: 'tablet', width: 1200 },
                    { name: 'mobile', width: 768 }
                ]
            },
            "dom": '<"row"<"col-sm-12 col-md-6"B><"col-sm-12 col-md-6"f>>' +
                   '<"row"<"col-sm-12"tr>>' +
                   '<"row"<"col-sm-12 col-md-5"i><"col-sm-12 col-md-7"p>>',
            "buttons": [
                {
                    extend: 'colvis',
                    text: '<i class="fas fa-columns"></i> Columns',
                    className: 'btn btn-secondary btn-sm',
                    columns: ':not(:last-child)',
                    collectionLayout: 'fixed two-column'
                },
                {
                    extend: 'copy',
                    text: '<i class="fas fa-copy"></i> Copy',
                    className: 'btn btn-secondary btn-sm',
                    exportOptions: {
                        columns: ':visible:not(:last-child)'
                    }
                },
                {
                    extend: 'excel',
                    text: '<i class="fas fa-file-excel"></i> Excel',
                    className: 'btn btn-success btn-sm',
                    exportOptions: {
                        columns: ':visible:not(:last-child)'
                    },
                    filename: 'job_applications_{{ vacancy.title|slugify }}_' + new Date().toISOString().slice(0, 10)
                },
                {
                    extend: 'pdf',
                    text: '<i class="fas fa-file-pdf"></i> PDF',
                    className: 'btn btn-danger btn-sm',
                    exportOptions: {
                        columns: ':visible:not(:last-child)'
                    },
                    filename: 'job_applications_{{ vacancy.title|slugify }}_' + new Date().toISOString().slice(0, 10),
                    orientation: 'landscape',
                    pageSize: 'A4'
                },
                {
                    extend: 'print',
                    text: '<i class="fas fa-print"></i> Print',
                    className: 'btn btn-info btn-sm',
                    exportOptions: {
                        columns: ':visible:not(:last-child)'
                    },
                    customize: function (win) {
                        $(win.document.body).find('table').addClass('display').css('font-size', '10px');
                        $(win.document.body).find('tr:nth-child(odd) td').css('background-color', '#f9f9f9');
                        $(win.document.body).find('h1').text('Job Applications for: {{ vacancy.title }} - ' + new Date().toLocaleDateString());
                    }
                },
                {
                    text: '<i class="fas fa-sync-alt"></i> Refresh',
                    className: 'btn btn-warning btn-sm',
                    action: function (e, dt, node, config) {
                        table.ajax.reload(null, false);
                        Swal.fire({
                            icon: 'success',
                            title: 'Refreshed',
                            text: 'Data has been refreshed successfully',
                            timer: 1500,
                            showConfirmButton: false
                        });
                    }
                }
            ],
            "colReorder": true,
            "fixedHeader": true,
            "language": {
                "search": "Search:",
                "lengthMenu": "Show _MENU_ entries",
                "info": "Showing _START_ to _END_ of _TOTAL_ entries",
                "infoEmpty": "Showing 0 to 0 of 0 entries",
                "infoFiltered": "(filtered from _MAX_ total entries)",
                "zeroRecords": "No matching applications found",
                "emptyTable": "No application data available",
                "processing": '<i class="fas fa-spinner fa-spin"></i> Loading...',
                "paginate": {
                    "first": "First",
                    "last": "Last",
                    "next": "Next",
                    "previous": "Previous"
                }
            },
            "initComplete": function (settings, json) {
                $('.dataTables_filter input')
                    .addClass('form-control form-control-sm')
                    .attr('placeholder', 'Search in name, email, phone, vacancy...')
                    .css('width', '300px')
                    .wrap('<div class="input-group"></div>')
                    .before('<span class="input-group-text"><i class="fas fa-search"></i></span>');

                $('.dataTables_length select').addClass('form-control form-control-sm');

                if (json && json.recordsTotal) {
                    $('#total-applications').text(json.recordsTotal);
                }
            },
            "drawCallback": function (settings) {
                initializeTableInteractions();
            }
        });

        function initializeTableInteractions() {
            // Initialize tooltips
            $('[data-bs-toggle="tooltip"]').tooltip();

            // Cover letter click functionality
            $('.description-tooltip').off('click').on('click', function (e) {
                e.preventDefault();
                var description = $(this).data('description') || 'No cover letter available';
                Swal.fire({
                    title: 'Cover Letter',
                    html: '<div style="text-align: left; max-height: 400px; overflow-y: auto; padding: 15px; background: #f8f9fa; border-radius: 5px; border: 1px solid #dee2e6; white-space: pre-wrap;">' +
                        description + '</div>',
                    icon: 'info',
                    confirmButtonText: 'Close',
                    width: '700px'
                });
            });

            // Status change functionality - Click on dropdown items
            $('.status-dropdown-item').off('click').on('click', function (e) {
                e.preventDefault();
                var applicationId = $(this).data('application-id');
                var newStatus = $(this).data('status');
                var dropdown = $(this).closest('.dropdown');
                var badge = dropdown.find('.status-badge');
                
                changeApplicationStatus(applicationId, newStatus, badge, dropdown);
            });

            // Direct click on status badge for quick change
            $('.status-badge.status-editable').off('click').on('click', function (e) {
                e.stopPropagation();
                var applicationId = $(this).data('application-id');
                var currentStatus = $(this).data('current-status');
                var badge = $(this);
                var dropdown = $(this).closest('.dropdown');

                // Quick status cycle
                var statusOrder = ['pending', 'reviewed', 'accepted', 'rejected'];
                var currentIndex = statusOrder.indexOf(currentStatus);
                var newIndex = (currentIndex + 1) % statusOrder.length;
                var newStatus = statusOrder[newIndex];

                changeApplicationStatus(applicationId, newStatus, badge, dropdown);
            });
        }

        function changeApplicationStatus(applicationId, newStatus, badgeElement, dropdownElement) {
            Swal.fire({
                title: 'Change Application Status?',
                text: `Are you sure you want to change the status to ${newStatus}?`,
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: 'Yes, change it!',
                cancelButtonText: 'Cancel',
                reverseButtons: true
            }).then((result) => {
                if (result.isConfirmed) {
                    $.ajax({
                        url: "{% url 'vacancy_app:toggle_application_status' 0 %}".replace('0', applicationId),
                        type: 'POST',
                        data: {
                            'status': newStatus,
                            'csrfmiddlewaretoken': '{{ csrf_token }}'
                        },
                        beforeSend: function () {
                            // Show loading state on the badge
                            badgeElement.html('<i class="fas fa-spinner fa-spin me-1"></i>Updating...');
                            badgeElement.prop('disabled', true);
                        },
                        success: function (response) {
                            if (response.success) {
                                // Update the badge immediately
                                updateStatusBadge(badgeElement, newStatus, response.new_status_display);

                                Swal.fire({
                                    icon: 'success',
                                    title: 'Status Updated',
                                    text: response.message,
                                    timer: 1500,
                                    showConfirmButton: false
                                });

                                // Close dropdown if open
                                if (dropdownElement) {
                                    dropdownElement.removeClass('show');
                                    dropdownElement.find('.dropdown-menu').removeClass('show');
                                }

                                // Reload table data after a short delay
                                setTimeout(function () {
                                    table.ajax.reload(null, false);
                                }, 1000);
                            } else {
                                Swal.fire({
                                    icon: 'error',
                                    title: 'Error',
                                    text: response.error || 'Failed to update status'
                                });
                            }
                        },
                        error: function (xhr, status, error) {
                            Swal.fire({
                                icon: 'error',
                                title: 'Error',
                                text: 'Failed to update status. Please try again.'
                            });
                        },
                        complete: function () {
                            badgeElement.prop('disabled', false);
                        }
                    });
                }
            });
        }

        function updateStatusBadge(badgeElement, newStatus, displayText) {
            // Remove all status classes
            badgeElement.removeClass('status-pending status-reviewed status-accepted status-rejected');

            // Add new status class
            badgeElement.addClass('status-' + newStatus);

            // Update text and icon
            var icons = {
                'pending': 'fa-clock',
                'reviewed': 'fa-eye',
                'accepted': 'fa-check',
                'rejected': 'fa-times'
            };

            badgeElement.html(`<i class="fas ${icons[newStatus]} me-1"></i>${displayText}`);
            badgeElement.data('current-status', newStatus);
        }

        // Add loading overlay
        $('#applications-table').on('processing.dt', function (e, settings, processing) {
            if (processing) {
                $(this).closest('.card').append('<div class="overlay"><i class="fas fa-3x fa-sync-alt fa-spin text-primary"></i></div>');
            } else {
                $(this).closest('.card').find('.overlay').remove();
            }
        });

        // Style buttons container
        $('.dt-buttons').addClass('btn-group flex-wrap gap-1 mb-2');
        $('.dt-button').addClass('btn-sm');

        // Handle responsive adjustments for buttons on small screens
        $(window).on('resize', function() {
            if ($(window).width() < 768) {
                $('.dt-buttons').addClass('justify-content-center');
                $('.dt-button').addClass('mb-1');
            } else {
                $('.dt-buttons').removeClass('justify-content-center');
                $('.dt-button').removeClass('mb-1');
            }
        }).trigger('resize');

        // Row click functionality
        $('#applications-table tbody').on('click', 'tr', function () {
            $(this).toggleClass('table-active');
        });
    }
    {% endif %}
</script>
{% endblock %}