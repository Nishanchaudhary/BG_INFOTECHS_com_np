{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container-fluid">
    <div class="card border-dark">
        <div class="card-header bg-primary text-white border-dark d-flex flex-column flex-md-row justify-content-between align-items-center">
            <h5 class="card-title mb-0">
                <i class="fas fa-blog me-2"></i>{{ page_title }}
            </h5>
            <a href="{% url 'blog_app:blog_create' %}" class="btn btn-light btn-sm mt-2 mt-md-0">
                <i class="fas fa-plus me-1"></i>Add New Blog Post
            </a>
        </div>
        <div class="card-body p-0">
            <!-- DataTable -->
            <div class="table-responsive">
                <table id="blogs-table" class="table table-hover table-striped table-bordered border-dark" style="width:100%; margin:0;">
                    <thead class="table-primary border-dark">
                        <tr>
                            <th style="border: 1px solid #000; border-bottom: 2px solid #000; padding: 12px; text-align: center;">Title & Description</th>
                            <th style="border: 1px solid #000; border-bottom: 2px solid #000; padding: 12px; text-align: center;">Image</th>
                            <th style="border: 1px solid #000; border-bottom: 2px solid #000; padding: 12px; text-align: center;">Slug</th>
                            <th style="border: 1px solid #000; border-bottom: 2px solid #000; padding: 12px; text-align: center;">Content</th>
                            <th style="border: 1px solid #000; border-bottom: 2px solid #000; padding: 12px; text-align: center;">Status</th>
                            <th style="border: 1px solid #000; border-bottom: 2px solid #000; padding: 12px; text-align: center;">Author</th>
                            <th style="border: 1px solid #000; border-bottom: 2px solid #000; padding: 12px; text-align: center;">Reading Time</th>
                            <th style="border: 1px solid #000; border-bottom: 2px solid #000; padding: 12px; text-align: center;">Created</th>
                            <th style="border: 1px solid #000; border-bottom: 2px solid #000; padding: 12px; text-align: center;">Published</th>
                            <th style="border: 1px solid #000; border-bottom: 2px solid #000; padding: 12px; text-align: center;">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="table-light border-dark">
                        <!-- Data will be loaded via AJAX -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<!-- DataTables CSS -->
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.13.4/css/dataTables.bootstrap5.min.css">
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/buttons/2.3.6/css/buttons.bootstrap5.min.css">
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/responsive/2.4.1/css/responsive.bootstrap5.min.css">

<style>
#blogs-table {
    border: 2px solid #000 !important;
    border-collapse: separate !important;
    background-color: white;
}

#blogs-table th,
#blogs-table td {
    border: 1px solid #000 !important;
    vertical-align: middle !important;
    padding: 12px 8px !important;
}

#blogs-table thead th {
    border-bottom: 2px solid #000 !important;
    background-color: #b8d4ff !important;
    font-weight: 600;
    font-size: 0.9rem;
}

.img-thumbnail-table {
    width: 50px;
    height: 50px;
    object-fit: cover;
    border-radius: 4px;
    border: 2px solid #dee2e6;
}

.description-tooltip {
    cursor: pointer;
    color: #007bff;
    padding: 4px 8px;
    border-radius: 4px;
    transition: background-color 0.2s;
}

.description-tooltip:hover {
    background-color: #f8f9fa;
    text-decoration: underline;
}

.status-toggle-btn {
    min-width: 120px;
    font-size: 0.8rem;
}

.btn-group-sm .btn {
    padding: 0.25rem 0.5rem;
    font-size: 0.8rem;
}

.overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(255, 255, 255, 0.8);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1000;
}

.dropdown-menu {
    min-width: 150px;
}

/* Responsive adjustments */
@media (max-width: 1200px) {
    #blogs-table th,
    #blogs-table td {
        padding: 10px 6px !important;
        font-size: 0.875rem;
    }
    
    .img-thumbnail-table {
        width: 40px;
        height: 40px;
    }
    
    .status-toggle-btn {
        min-width: 100px;
        font-size: 0.75rem;
    }
}

@media (max-width: 992px) {
    #blogs-table th,
    #blogs-table td {
        padding: 8px 4px !important;
        font-size: 0.85rem;
    }
    
    .card-header {
        padding: 1rem !important;
    }
    
    .dataTables_wrapper .dt-buttons {
        text-align: center;
        margin-bottom: 10px;
    }
    
    .dataTables_wrapper .dt-buttons .btn {
        margin: 2px;
        font-size: 0.75rem;
        padding: 0.25rem 0.5rem;
    }
}

@media (max-width: 768px) {
    #blogs-table th,
    #blogs-table td {
        padding: 6px 3px !important;
        font-size: 0.8rem;
    }
    
    .img-thumbnail-table {
        width: 35px;
        height: 35px;
    }
    
    .status-toggle-btn {
        min-width: 80px;
        font-size: 0.7rem;
    }
    
    .btn-group-sm .btn {
        padding: 0.2rem 0.4rem;
        font-size: 0.75rem;
    }
    
    .table-responsive {
        font-size: 0.875rem;
    }
    
    /* DataTables responsive child row styling */
    .dtr-details {
        width: 100% !important;
    }
    
    .dtr-details li {
        border-bottom: 1px solid #eee;
        padding: 8px 0;
    }
    
    .dtr-details .dtr-title {
        font-weight: 600;
        min-width: 100px;
        display: inline-block;
    }
}

@media (max-width: 576px) {
    .card-header h5 {
        font-size: 1.1rem;
    }
    
    .table-responsive {
        font-size: 0.8rem;
    }
    
    #blogs-table th,
    #blogs-table td {
        padding: 4px 2px !important;
    }
    
    .btn {
        font-size: 0.8rem;
    }
    
    .dataTables_filter input {
        width: 100% !important;
        margin-top: 10px;
    }
    
    .dataTables_length {
        margin-bottom: 10px;
    }
    
    /* Stack buttons vertically on very small screens */
    .dt-buttons .btn {
        display: block;
        width: 100%;
        margin: 2px 0;
    }
    
    .img-thumbnail-table {
        width: 30px;
        height: 30px;
    }
}

/* Custom scrollbar for table */
.table-responsive::-webkit-scrollbar {
    height: 8px;
}

.table-responsive::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 10px;
}

.table-responsive::-webkit-scrollbar-thumb {
    background: #c1c1c1;
    border-radius: 10px;
}

.table-responsive::-webkit-scrollbar-thumb:hover {
    background: #a8a8a8;
}

/* DataTables responsive styling */
table.dataTable.dtr-inline.collapsed > tbody > tr > td.dtr-control:before,
table.dataTable.dtr-inline.collapsed > tbody > tr > th.dtr-control:before {
    background-color: #4e73df;
    border: 2px solid white;
    box-shadow: 0 0 3px #444;
}

table.dataTable.dtr-inline.collapsed > tbody > tr.parent > td.dtr-control:before,
table.dataTable.dtr-inline.collapsed > tbody > tr.parent > th.dtr-control:before {
    background-color: #e74a3b;
}

/* Mobile action buttons */
.mobile-actions {
    display: none;
}

@media (max-width: 768px) {
    .desktop-actions {
        display: none;
    }
    
    .mobile-actions {
        display: flex;
        justify-content: center;
        gap: 3px;
    }
    
    .mobile-actions .btn {
        padding: 0.15rem 0.3rem;
        font-size: 0.65rem;
    }
}

/* Loading states */
.dataTables_processing {
    background: linear-gradient(90deg, transparent, rgba(78, 115, 223, 0.1), transparent) !important;
    background-size: 200% 100% !important;
    animation: loading 1.5s infinite !important;
}

@keyframes loading {
    0% { background-position: 200% 0; }
    100% { background-position: -200% 0; }
}

/* Ensure proper row hover on mobile */
.table-hover tbody tr:hover {
    background-color: rgba(0, 123, 255, 0.1) !important;
}
</style>
{% endblock %}

{% block extra_js %}
<!-- DataTables JS -->
<script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.4/js/dataTables.bootstrap5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.3.6/js/dataTables.buttons.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.3.6/js/buttons.bootstrap5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.3.6/js/buttons.html5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.3.6/js/buttons.print.min.js"></script>
<script src="https://cdn.datatables.net/responsive/2.4.1/js/dataTables.responsive.min.js"></script>
<script src="https://cdn.datatables.net/responsive/2.4.1/js/responsive.bootstrap5.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/pdfmake.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/vfs_fonts.js"></script>

<script>
$(document).ready(function() {
    var table = $('#blogs-table').DataTable({
        "processing": true,
        "serverSide": true,
        "ajax": {
            "url": "{% url 'blog_app:blogs_datatables' %}",
            "type": "GET",
            "dataType": "json",
            "error": function(xhr, error, code) {
                console.log(xhr);
                console.log(error);
                console.log(code);
                Swal.fire({
                    icon: 'error',
                    title: 'Data Loading Error',
                    text: 'Unable to load blog data. Please try again.',
                    timer: 3000
                });
            }
        },
        "columns": [
            {
                "data": "title", 
                "name": "title", 
                "className": "text-left",
                "responsivePriority": 1,
                "render": function(data, type, row) {
                    if (type === 'display') {
                        return `<div class="fw-bold">${data || ''}</div>`;
                    }
                    return data;
                }
            },
            {
                "data": "image", 
                "name": "image", 
                "className": "text-center", 
                "orderable": false, 
                "searchable": false,
                "responsivePriority": 6
            },
            {
                "data": "slug", 
                "name": "slug", 
                "className": "text-center",
                "responsivePriority": 4
            },
            {
                "data": "description", 
                "name": "description", 
                "className": "text-center", 
                "orderable": false,
                "responsivePriority": 3,
                "render": function(data, type, row) {
                    if (type === 'display' && data) {
                        var shortDesc = data.length > 50 ? data.substr(0, 50) + '...' : data;
                        return `<span class="description-tooltip" data-description="${data.replace(/"/g, '&quot;')}">${shortDesc}</span>`;
                    }
                    return data;
                }
            },
            {
                "data": "status", 
                "name": "status", 
                "className": "text-center", 
                "orderable": false,
                "responsivePriority": 2
            },
            {
                "data": "author", 
                "name": "author", 
                "className": "text-center",
                "responsivePriority": 5
            },
            {
                "data": "reading_time", 
                "name": "reading_time", 
                "className": "text-center", 
                "orderable": false,
                "responsivePriority": 7
            },
            {
                "data": "created_at", 
                "name": "created_at", 
                "className": "text-center",
                "responsivePriority": 8
            },
            {
                "data": "published_at", 
                "name": "published_at", 
                "className": "text-center",
                "responsivePriority": 9
            },
            {
                "data": "actions", 
                "name": "actions", 
                "className": "text-center", 
                "orderable": false, 
                "searchable": false,
                "responsivePriority": 1,
                "render": function(data, type, row) {
                    if (type === 'display') {
                        return `
                            <div class="desktop-actions">
                                ${data || ''}
                            </div>
                            <div class="mobile-actions">
                                ${data || ''}
                            </div>
                        `;
                    }
                    return data;
                }
            }
        ],
        "order": [[7, 'desc']],
        "pageLength": 10,
        "lengthMenu": [[10, 25, 50, 100, -1], [10, 25, 50, 100, "All"]],
        "responsive": {
            details: {
                display: $.fn.dataTable.Responsive.display.modal({
                    header: function (row) {
                        var data = row.data();
                        return 'Blog Post Details: ' + data.title;
                    }
                }),
                renderer: function (api, rowIdx, columns) {
                    var data = $.map(columns, function (col, i) {
                        return '<tr>' +
                            '<td class="fw-bold">' + col.title + ':' + '</td> ' +
                            '<td>' + (col.data || '') + '</td>' +
                            '</tr>';
                    }).join('');

                    return $('<table class="table table-sm"/>').append(data);
                }
            },
            breakpoints: [
                { name: 'desktop', width: Infinity },
                { name: 'tablet', width: 1200 },
                { name: 'mobile', width: 768 }
            ]
        },
        "dom": '<"row"<"col-sm-12 col-md-6"B><"col-sm-12 col-md-6"f>>' +
               '<"row"<"col-sm-12"tr>>' +
               '<"row"<"col-sm-12 col-md-5"i><"col-sm-12 col-md-7"p>>',
        "buttons": [
            {
                extend: 'copy',
                text: '<i class="fas fa-copy"></i> Copy',
                className: 'btn btn-secondary btn-sm',
                exportOptions: {
                    columns: [0, 2, 4, 5, 6, 7, 8]
                }
            },
            {
                extend: 'excel',
                text: '<i class="fas fa-file-excel"></i> Excel',
                className: 'btn btn-success btn-sm',
                exportOptions: {
                    columns: [0, 2, 4, 5, 6, 7, 8]
                },
                filename: 'blogs_list_' + new Date().toISOString().slice(0, 10)
            },
            {
                extend: 'pdf',
                text: '<i class="fas fa-file-pdf"></i> PDF',
                className: 'btn btn-danger btn-sm',
                exportOptions: {
                    columns: [0, 2, 4, 5, 6, 7, 8]
                },
                filename: 'blogs_list_' + new Date().toISOString().slice(0, 10),
                orientation: 'landscape',
                pageSize: 'A4'
            },
            {
                extend: 'print',
                text: '<i class="fas fa-print"></i> Print',
                className: 'btn btn-info btn-sm',
                exportOptions: {
                    columns: [0, 2, 4, 5, 6, 7, 8]
                },
                customize: function (win) {
                    $(win.document.body).find('table').addClass('display').css('font-size', '10px');
                    $(win.document.body).find('tr:nth-child(odd) td').css('background-color','#f9f9f9');
                    $(win.document.body).find('h1').text('Blog Posts List - ' + new Date().toLocaleDateString());
                }
            },
            {
                text: '<i class="fas fa-plus"></i> Add Blog',
                className: 'btn btn-primary btn-sm',
                action: function (e, dt, node, config) {
                    window.location.href = "{% url 'blog_app:blog_create' %}";
                }
            },
            {
                text: '<i class="fas fa-sync-alt"></i> Refresh',
                className: 'btn btn-warning btn-sm',
                action: function (e, dt, node, config) {
                    table.ajax.reload();
                    Swal.fire({
                        icon: 'success',
                        title: 'Refreshed',
                        text: 'Data has been refreshed successfully',
                        timer: 1500,
                        showConfirmButton: false
                    });
                }
            }
        ],
        "language": {
            "search": "Search in all columns:",
            "lengthMenu": "Show _MENU_ entries",
            "info": "Showing _START_ to _END_ of _TOTAL_ entries",
            "infoEmpty": "Showing 0 to 0 of 0 entries",
            "infoFiltered": "(filtered from _MAX_ total entries)",
            "zeroRecords": "No matching blogs found",
            "emptyTable": "No blog data available",
            "processing": '<i class="fas fa-spinner fa-spin"></i> Loading...',
            "paginate": {
                "first": "First",
                "last": "Last",
                "next": "Next",
                "previous": "Previous"
            },
            "buttons": {
                "copy": "Copy",
                "excel": "Excel",
                "pdf": "PDF",
                "print": "Print",
                "colvis": "Columns"
            }
        },
        "initComplete": function() {
            $('.dataTables_filter input')
                .addClass('form-control form-control-sm')
                .attr('placeholder', 'Search in title, description, slug...')
                .css('width', '300px')
                .wrap('<div class="input-group"></div>')
                .before('<span class="input-group-text"><i class="fas fa-search"></i></span>');

            $('.dataTables_length select').addClass('form-control form-control-sm');
            
            $('#blogs-table').on('processing.dt', function (e, settings, processing) {
                if (processing) {
                    $(this).closest('.card').append('<div class="overlay"><i class="fas fa-3x fa-sync-alt fa-spin"></i></div>');
                } else {
                    $(this).closest('.card').find('.overlay').remove();
                }
            });
        },
        "drawCallback": function() {
            $('[data-bs-toggle="tooltip"]').tooltip();
            
            // Description click functionality
            $('.description-tooltip').on('click', function() {
                var description = $(this).data('description');
                Swal.fire({
                    title: 'Full Content',
                    html: '<div style="text-align: left; max-height: 400px; overflow-y: auto; padding: 10px; background: #f8f9fa; border-radius: 5px;">' + 
                          description.replace(/\n/g, '<br>') + '</div>',
                    icon: 'info',
                    confirmButtonText: 'Close',
                    width: '700px',
                    customClass: {
                        popup: 'description-popup'
                    }
                });
            });

            // Status change functionality
            $('.status-change-btn').on('click', function(e) {
                e.preventDefault();
                var blogId = $(this).data('blog-id');
                var newStatus = $(this).data('status');
                var button = $(this).closest('.dropdown').find('.status-toggle-btn');
                
                Swal.fire({
                    title: 'Change Status?',
                    text: `Are you sure you want to change the status to ${newStatus}?`,
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonText: 'Yes, change it!',
                    cancelButtonText: 'Cancel'
                }).then((result) => {
                    if (result.isConfirmed) {
                        $.ajax({
                            url: "{% url 'blog_app:toggle_blog_status' 0 %}".replace('0', blogId),
                            type: 'POST',
                            data: {
                                'status': newStatus,
                                'csrfmiddlewaretoken': '{{ csrf_token }}'
                            },
                            beforeSend: function() {
                                button.prop('disabled', true);
                                button.html('<i class="fas fa-spinner fa-spin me-1"></i>Updating...');
                            },
                            success: function(response) {
                                if (response.success) {
                                    // Update button appearance based on new status
                                    var statusClasses = {
                                        'draft': 'btn-secondary',
                                        'published': 'btn-success',
                                        'archived': 'btn-warning'
                                    };
                                    var statusIcons = {
                                        'draft': 'fa-edit',
                                        'published': 'fa-check-circle',
                                        'archived': 'fa-archive'
                                    };
                                    var statusTexts = {
                                        'draft': 'Draft',
                                        'published': 'Published',
                                        'archived': 'Archived'
                                    };
                                    
                                    button.removeClass('btn-secondary btn-success btn-warning')
                                          .addClass(statusClasses[response.new_status]);
                                    button.html('<i class="fas ' + statusIcons[response.new_status] + ' me-1"></i>' + statusTexts[response.new_status]);
                                    
                                    Swal.fire({
                                        icon: 'success',
                                        title: 'Status Updated',
                                        text: response.message,
                                        timer: 1500,
                                        showConfirmButton: false
                                    });
                                    
                                    // Reload table after a short delay
                                    setTimeout(function() {
                                        table.ajax.reload();
                                    }, 1000);
                                } else {
                                    Swal.fire({
                                        icon: 'error',
                                        title: 'Error',
                                        text: response.error
                                    });
                                }
                            },
                            error: function(xhr, status, error) {
                                Swal.fire({
                                    icon: 'error',
                                    title: 'Error',
                                    text: 'Failed to update status. Please try again.'
                                });
                            },
                            complete: function() {
                                button.prop('disabled', false);
                            }
                        });
                    }
                });
            });
        }
    });

    $('#blogs-table_filter input').unbind().bind('keyup', function() {
        table.search(this.value).draw();
    });

    $('.dt-buttons').addClass('btn-group flex-wrap');
    $('.dt-button').addClass('btn btn-sm m-1');
    $('.dt-buttons').css('margin-bottom', '10px');

    // Handle responsive adjustments for buttons on small screens
    $(window).on('resize', function() {
        if ($(window).width() < 768) {
            $('.dt-buttons').addClass('justify-content-center');
            $('.dt-button').addClass('mb-1');
        } else {
            $('.dt-buttons').removeClass('justify-content-center');
            $('.dt-button').removeClass('mb-1');
        }
    }).trigger('resize');

    $('#blogs-table tbody').on('click', 'tr', function() {
        $(this).toggleClass('table-active');
    });
});
</script>
{% endblock %}