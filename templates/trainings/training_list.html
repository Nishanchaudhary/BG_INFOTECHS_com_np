{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container-fluid">
    <div class="card border-dark">
        <div class="card-header bg-primary text-white border-dark d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center">
            <h5 class="card-title mb-2 mb-md-0">
                <i class="fas fa-laptop-code me-2"></i>{{ page_title }}
            </h5>
           
        </div>
        <div class="card-body p-0">
            <!-- DataTable -->
            <div class="table-responsive">
                <table id="trainings-table" class="table table-hover table-striped table-bordered border-dark" style="width:100%; margin:0;">
                    <thead class="table-primary border-dark">
                        <tr>
                            <th style="border: 1px solid #000; border-bottom: 2px solid #000; padding: 12px; text-align: center;">Title</th>
                            <th style="border: 1px solid #000; border-bottom: 2px solid #000; padding: 12px; text-align: center;">Image</th>
                            <th style="border: 1px solid #000; border-bottom: 2px solid #000; padding: 12px; text-align: center;">Duration</th>
                            <th style="border: 1px solid #000; border-bottom: 2px solid #000; padding: 12px; text-align: center;">Description</th>
                            <th style="border: 1px solid #000; border-bottom: 2px solid #000; padding: 12px; text-align: center;">Price</th>
                            <th style="border: 1px solid #000; border-bottom: 2px solid #000; padding: 12px; text-align: center;">Offer Price</th>
                            <th style="border: 1px solid #000; border-bottom: 2px solid #000; padding: 12px; text-align: center;">Discount</th>
                            <th style="border: 1px solid #000; border-bottom: 2px solid #000; padding: 12px; text-align: center;">Status</th>
                            <th style="border: 1px solid #000; border-bottom: 2px solid #000; padding: 12px; text-align: center;">Created</th>
                            <th style="border: 1px solid #000; border-bottom: 2px solid #000; padding: 12px; text-align: center;">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="table-light border-dark">
                        <!-- Data will be loaded via AJAX -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<!-- DataTables CSS -->
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.13.4/css/dataTables.bootstrap5.min.css">
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/buttons/2.3.6/css/buttons.bootstrap5.min.css">
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/responsive/2.4.1/css/responsive.bootstrap5.min.css">

<style>
#trainings-table {
    border: 2px solid #000 !important;
    border-collapse: separate !important;
    background-color: white;
}

#trainings-table th,
#trainings-table td {
    border: 1px solid #000 !important;
    vertical-align: middle !important;
    padding: 12px 8px !important;
}

#trainings-table thead th {
    border-bottom: 2px solid #000 !important;
    background-color: #b8d4ff !important;
    font-weight: 600;
    font-size: 0.9rem;
}

.img-thumbnail-table {
    width: 50px;
    height: 50px;
    object-fit: cover;
    border-radius: 4px;
    border: 2px solid #dee2e6;
}

.badge-discount {
    font-size: 0.75rem;
    padding: 0.35em 0.65em;
}

.price-text {
    font-weight: 600;
}

.offer-price-text {
    font-weight: 600;
    color: #28a745;
}

.description-tooltip {
    cursor: pointer;
    color: #007bff;
    padding: 4px 8px;
    border-radius: 4px;
    transition: background-color 0.2s;
}

.description-tooltip:hover {
    background-color: #f8f9fa;
    text-decoration: underline;
}

.status-toggle-btn {
    min-width: 90px;
    font-size: 0.8rem;
}

.btn-group-sm .btn {
    padding: 0.25rem 0.5rem;
    font-size: 0.8rem;
}

.overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(255, 255, 255, 0.8);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1000;
}

/* Responsive Design */
@media (max-width: 768px) {
    .container-fluid {
        padding: 0 10px;
    }
    
    .card-body {
        padding: 0 !important;
    }
    
    .table th,
    .table td {
        padding: 8px 6px !important;
        font-size: 0.875rem;
    }
    
    #trainings-table th,
    #trainings-table td {
        padding: 8px 6px !important;
        font-size: 0.875rem;
    }
    
    .btn-group {
        justify-content: flex-start;
    }
    
    .btn {
        font-size: 0.875rem;
        padding: 0.375rem 0.75rem;
    }
    
    .btn-sm {
        font-size: 0.775rem;
        padding: 0.25rem 0.5rem;
    }
    
    .dataTables_wrapper .dataTables_filter input {
        width: 100% !important;
        margin-bottom: 10px;
    }
    
    .card-header {
        padding: 1rem !important;
    }
    
    .card-header .d-flex {
        flex-direction: column;
        gap: 10px;
        align-items: flex-start !important;
    }
    
    .card-header .btn {
        align-self: flex-start;
    }
    
    /* Hide less important columns on mobile */
    #trainings-table thead th:nth-child(2),
    #trainings-table thead th:nth-child(4),
    #trainings-table thead th:nth-child(6),
    #trainings-table thead th:nth-child(7) {
        display: none;
    }
    
    #trainings-table tbody td:nth-child(2),
    #trainings-table tbody td:nth-child(4),
    #trainings-table tbody td:nth-child(6),
    #trainings-table tbody td:nth-child(7) {
        display: none;
    }
    
    .dt-buttons {
        text-align: center;
    }
    
    .dt-button {
        margin: 2px;
        font-size: 0.8rem;
        padding: 0.25rem 0.5rem;
    }
}

@media (max-width: 576px) {
    .h5, .h6 {
        font-size: 1.1rem;
    }
    
    .card-header h5 {
        font-size: 1rem;
    }
    
    .table th,
    .table td {
        padding: 6px 4px !important;
        font-size: 0.8rem;
    }
    
    #trainings-table th,
    #trainings-table td {
        padding: 6px 4px !important;
        font-size: 0.8rem;
    }
    
    .btn-sm {
        font-size: 0.775rem;
        padding: 0.25rem 0.5rem;
    }
    
    .dataTables_info,
    .dataTables_paginate {
        font-size: 0.8rem;
    }
    
    /* Further simplify tables on very small screens */
    #trainings-table thead th:nth-child(5),
    #trainings-table thead th:nth-child(9) {
        display: none;
    }
    
    #trainings-table tbody td:nth-child(5),
    #trainings-table tbody td:nth-child(9) {
        display: none;
    }
    
    .status-toggle-btn {
        min-width: 70px;
        font-size: 0.7rem;
    }
}

@media (max-width: 400px) {
    .container-fluid {
        padding: 0 5px;
    }
    
    .btn-group {
        flex-direction: column;
        width: 100%;
    }
    
    .dt-buttons {
        display: flex;
        flex-direction: column;
        gap: 5px;
    }
    
    .dt-button {
        width: 100%;
        margin: 0;
        justify-content: center;
    }
    
    .dataTables_length label {
        display: flex;
        flex-direction: column;
        align-items: flex-start;
        gap: 5px;
    }
    
    .dataTables_length select {
        margin: 0 !important;
    }
    
    .img-thumbnail-table {
        width: 40px;
        height: 40px;
    }
}

/* DataTables responsive fixes */
table.dataTable.dtr-inline.collapsed > tbody > tr > td.dtr-control:before,
table.dataTable.dtr-inline.collapsed > tbody > tr > th.dtr-control:before {
    background-color: #0d6efd;
    border: 2px solid white;
    box-shadow: 0 0 3px #444;
}

table.dataTable.dtr-inline.collapsed > tbody > tr.parent > td.dtr-control:before,
table.dataTable.dtr-inline.collapsed > tbody > tr.parent > th.dtr-control:before {
    background-color: #dc3545;
}

/* Print optimization */
@media print {
    .dt-buttons, .dataTables_filter, .dataTables_length, .dataTables_info, .dataTables_paginate {
        display: none !important;
    }
    
    .table {
        border: 1px solid #000 !important;
        font-size: 10px;
    }
    
    .table th,
    .table td {
        padding: 4px 6px !important;
    }
    
    .btn-group,
    .card-header .btn {
        display: none !important;
    }
}

/* Mobile-first responsive utilities */
.d-none.d-sm-inline {
    display: none;
}

@media (min-width: 576px) {
    .d-none.d-sm-inline {
        display: inline !important;
    }
}

/* Ensure proper spacing on all devices */
.mb-2 {
    margin-bottom: 0.5rem !important;
}

/* Responsive flexbox utilities */
@media (min-width: 768px) {
    .mb-md-0 {
        margin-bottom: 0 !important;
    }
}

/* Flexbox utilities for responsive layout */
.flex-wrap {
    flex-wrap: wrap !important;
}

@media (max-width: 400px) {
    .flex-wrap {
        flex-direction: column;
    }
}

/* Button text responsiveness */
.btn-text-responsive {
    display: inline;
}

@media (max-width: 576px) {
    .btn-text-responsive {
        display: none;
    }
}

/* DataTables button icons on mobile */
@media (max-width: 576px) {
    .dt-button span:not(.fa) {
        display: none;
    }
    
    .dt-button .fa {
        margin-right: 0 !important;
    }
}
</style>
{% endblock %}

{% block extra_js %}
<!-- DataTables JS -->
<script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.4/js/dataTables.bootstrap5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.3.6/js/dataTables.buttons.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.3.6/js/buttons.bootstrap5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.3.6/js/buttons.html5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.3.6/js/buttons.print.min.js"></script>
<script src="https://cdn.datatables.net/responsive/2.4.1/js/dataTables.responsive.min.js"></script>
<script src="https://cdn.datatables.net/responsive/2.4.1/js/responsive.bootstrap5.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/pdfmake.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/vfs_fonts.js"></script>

<script>
$(document).ready(function() {
    var table = $('#trainings-table').DataTable({
        "processing": true,
        "serverSide": true,
        "ajax": {
            "url": "{% url 'trainings_app:trainings_datatables' %}",
            "type": "GET",
            "dataType": "json",
            "error": function(xhr, error, code) {
                console.log(xhr);
                console.log(error);
                console.log(code);
                Swal.fire({
                    icon: 'error',
                    title: 'Data Loading Error',
                    text: 'Unable to load training data. Please try again.',
                    timer: 3000
                });
            }
        },
        "columns": [
            {"data": "title", "name": "title", "className": "text-center"},
            {"data": "image", "name": "image", "className": "text-center", "orderable": false, "searchable": false},
            {"data": "duration", "name": "duration", "className": "text-center"},
            {"data": "description", "name": "description", "className": "text-center", "orderable": false},
            {"data": "price", "name": "price", "className": "text-center"},
            {"data": "offer_price", "name": "offer_price", "className": "text-center"},
            {"data": "discount", "name": "discount", "className": "text-center", "orderable": false},
            {"data": "status", "name": "status", "className": "text-center", "orderable": false},
            {"data": "created_at", "name": "created_at", "className": "text-center"},
            {"data": "actions", "name": "actions", "className": "text-center", "orderable": false, "searchable": false}
        ],
        "order": [[8, 'desc']],
        "pageLength": 10,
        "lengthMenu": [[10, 25, 50, 100, -1], [10, 25, 50, 100, "All"]],
        "responsive": true,
        "dom": '<"row"<"col-sm-12 col-md-6"B><"col-sm-12 col-md-6"f>>rtip',
        "buttons": [
            {
                extend: 'copy',
                text: '<i class="fas fa-copy"></i> <span class="btn-text-responsive">Copy</span>',
                className: 'btn btn-secondary btn-sm',
                exportOptions: {
                    columns: [0, 2, 3, 4, 5, 6, 7, 8]
                }
            },
            {
                extend: 'excel',
                text: '<i class="fas fa-file-excel"></i> <span class="btn-text-responsive">Excel</span>',
                className: 'btn btn-success btn-sm',
                exportOptions: {
                    columns: [0, 2, 3, 4, 5, 6, 7, 8]
                },
                filename: 'trainings_list_' + new Date().toISOString().slice(0, 10)
            },
            {
                extend: 'pdf',
                text: '<i class="fas fa-file-pdf"></i> <span class="btn-text-responsive">PDF</span>',
                className: 'btn btn-danger btn-sm',
                exportOptions: {
                    columns: [0, 2, 3, 4, 5, 6, 7, 8]
                },
                filename: 'trainings_list_' + new Date().toISOString().slice(0, 10),
                orientation: 'landscape',
                pageSize: 'A4'
            },
            {
                extend: 'print',
                text: '<i class="fas fa-print"></i> <span class="btn-text-responsive">Print</span>',
                className: 'btn btn-info btn-sm',
                exportOptions: {
                    columns: [0, 2, 3, 4, 5, 6, 7, 8]
                },
                customize: function (win) {
                    $(win.document.body).find('table').addClass('display').css('font-size', '10px');
                    $(win.document.body).find('tr:nth-child(odd) td').css('background-color','#f9f9f9');
                    $(win.document.body).find('h1').text('Trainings List - ' + new Date().toLocaleDateString());
                }
            },
            {
                text: '<i class="fas fa-plus"></i> <span class="btn-text-responsive">Add Training</span>',
                className: 'btn btn-primary btn-sm',
                action: function (e, dt, node, config) {
                    window.location.href = "{% url 'trainings_app:training_create' %}";
                }
            },
            {
                text: '<i class="fas fa-sync-alt"></i> <span class="btn-text-responsive">Refresh</span>',
                className: 'btn btn-warning btn-sm',
                action: function (e, dt, node, config) {
                    table.ajax.reload();
                    Swal.fire({
                        icon: 'success',
                        title: 'Refreshed',
                        text: 'Data has been refreshed successfully',
                        timer: 1500,
                        showConfirmButton: false
                    });
                }
            }
        ],
        "language": {
            "search": "Search in all columns:",
            "lengthMenu": "Show _MENU_ entries",
            "info": "Showing _START_ to _END_ of _TOTAL_ entries",
            "infoEmpty": "Showing 0 to 0 of 0 entries",
            "infoFiltered": "(filtered from _MAX_ total entries)",
            "zeroRecords": "No matching trainings found",
            "emptyTable": "No training data available",
            "processing": '<i class="fas fa-spinner fa-spin"></i> Loading...',
            "paginate": {
                "first": "First",
                "last": "Last",
                "next": "Next",
                "previous": "Previous"
            },
            "buttons": {
                "copy": "Copy",
                "excel": "Excel",
                "pdf": "PDF",
                "print": "Print",
                "colvis": "Columns"
            }
        },
        "initComplete": function() {
            $('.dataTables_filter input')
                .addClass('form-control form-control-sm')
                .attr('placeholder', 'Search in title, description, duration...')
                .css('width', '300px')
                .wrap('<div class="input-group"></div>')
                .before('<span class="input-group-text"><i class="fas fa-search"></i></span>');

            $('.dataTables_length select').addClass('form-control form-control-sm');
            
            $('#trainings-table').on('processing.dt', function (e, settings, processing) {
                if (processing) {
                    $(this).closest('.card').append('<div class="overlay"><i class="fas fa-3x fa-sync-alt fa-spin"></i></div>');
                } else {
                    $(this).closest('.card').find('.overlay').remove();
                }
            });
            
            // Responsive button adjustments
            $('.dt-buttons').addClass('btn-group flex-wrap');
            $('.dt-button').addClass('btn btn-sm m-1');
            $('.dt-buttons').css('margin-bottom', '10px');
        },
        "drawCallback": function() {
            $('[data-bs-toggle="tooltip"]').tooltip();
            
            // Description click functionality
            $('.description-tooltip').on('click', function() {
                var description = $(this).data('description');
                Swal.fire({
                    title: 'Full Description',
                    html: '<div style="text-align: left; max-height: 400px; overflow-y: auto; padding: 10px; background: #f8f9fa; border-radius: 5px;">' + 
                          description.replace(/\n/g, '<br>') + '</div>',
                    icon: 'info',
                    confirmButtonText: 'Close',
                    width: '700px',
                    customClass: {
                        popup: 'description-popup'
                    }
                });
            });

            // Status toggle button functionality
            $('.status-toggle-btn').on('click', function() {
                var trainingId = $(this).data('training-id');
                var currentStatus = $(this).data('status');
                var button = $(this);
                
                $.ajax({
                    url: "{% url 'trainings_app:toggle_training_status' 0 %}".replace('0', trainingId),
                    type: 'POST',
                    data: {
                        'csrfmiddlewaretoken': '{{ csrf_token }}'
                    },
                    beforeSend: function() {
                        button.prop('disabled', true);
                        button.html('<i class="fas fa-spinner fa-spin me-1"></i>Updating...');
                    },
                    success: function(response) {
                        if (response.success) {
                            // Update button appearance
                            if (response.new_status) {
                                button.removeClass('btn-warning').addClass('btn-success');
                                button.html('<i class="fas fa-check-circle me-1"></i>Active');
                                button.data('status', true);
                            } else {
                                button.removeClass('btn-success').addClass('btn-warning');
                                button.html('<i class="fas fa-times-circle me-1"></i>Inactive');
                                button.data('status', false);
                            }
                            
                            Swal.fire({
                                icon: 'success',
                                title: 'Status Updated',
                                text: response.message,
                                timer: 1500,
                                showConfirmButton: false
                            });
                        } else {
                            Swal.fire({
                                icon: 'error',
                                title: 'Error',
                                text: response.error
                            });
                        }
                    },
                    error: function(xhr, status, error) {
                        Swal.fire({
                            icon: 'error',
                            title: 'Error',
                            text: 'Failed to update status. Please try again.'
                        });
                    },
                    complete: function() {
                        button.prop('disabled', false);
                    }
                });
            });
        },
        "responsive": {
            "details": {
                "display": $.fn.dataTable.Responsive.display.modal({
                    "header": function (row) {
                        var data = row.data();
                        return 'Training Details: ' + data.title;
                    }
                }),
                "renderer": $.fn.dataTable.Responsive.renderer.tableAll()
            }
        }
    });

    $('#trainings-table_filter input').unbind().bind('keyup', function() {
        table.search(this.value).draw();
    });

    $('#trainings-table tbody').on('click', 'tr', function() {
        $(this).toggleClass('table-active');
    });
});

function formatPrice(price) {
    return 'â‚¹' + parseInt(price).toLocaleString('en-IN');
}
</script>
{% endblock %}