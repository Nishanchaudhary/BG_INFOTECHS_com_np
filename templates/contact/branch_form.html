{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container-fluid">
    <div class="card border-dark">
        <div class="card-header bg-success text-white border-dark">
            <h5 class="card-title mb-0">
                <i class="fas {% if breadcrumb_icon %}{{ breadcrumb_icon }}{% else %}fa-edit{% endif %} me-2"></i>{{ page_title }}
            </h5>
        </div>
        <div class="card-body">
            <!-- Messages -->
            {% if messages %}
            <div class="row mb-4">
                <div class="col-12">
                    {% for message in messages %}
                    <div class="alert alert-{{ message.tags }} alert-dismissible fade show border-dark" role="alert">
                        <i class="fas {% if message.tags == 'success' %}fa-check-circle{% else %}fa-exclamation-triangle{% endif %} me-2"></i>
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            <!-- Form -->
            <form method="post" enctype="multipart/form-data" novalidate class="needs-validation">
                {% csrf_token %}
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="{{ form.name.id_for_label }}" class="form-label fw-bold">
                                <i class="fas fa-building me-1 text-success"></i>{{ form.name.label }}
                            </label>
                            {{ form.name }}
                            {% if form.name.errors %}
                            <div class="invalid-feedback d-block">
                                <i class="fas fa-exclamation-circle me-1"></i>{{ form.name.errors.0 }}
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="{{ form.email.id_for_label }}" class="form-label fw-bold">
                                <i class="fas fa-envelope me-1 text-success"></i>{{ form.email.label }}
                            </label>
                            {{ form.email }}
                            {% if form.email.errors %}
                            <div class="invalid-feedback d-block">
                                <i class="fas fa-exclamation-circle me-1"></i>{{ form.email.errors.0 }}
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-12">
                        <div class="mb-3">
                            <label for="{{ form.address.id_for_label }}" class="form-label fw-bold">
                                <i class="fas fa-map-marker-alt me-1 text-success"></i>{{ form.address.label }}
                            </label>
                            {{ form.address }}
                            {% if form.address.errors %}
                            <div class="invalid-feedback d-block">
                                <i class="fas fa-exclamation-circle me-1"></i>{{ form.address.errors.0 }}
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="{{ form.phone_numbers.id_for_label }}" class="form-label fw-bold">
                                <i class="fas fa-phone me-1 text-success"></i>Phone Numbers
                            </label>
                            {{ form.phone_numbers }}
                            <small class="form-text text-muted">
                                <i class="fas fa-info-circle me-1"></i>{{ form.phone_numbers.help_text }}
                            </small>
                            {% if form.phone_numbers.errors %}
                            <div class="invalid-feedback d-block">
                                <i class="fas fa-exclamation-circle me-1"></i>{{ form.phone_numbers.errors.0 }}
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="{{ form.office_open.id_for_label }}" class="form-label fw-bold">
                                <i class="fas fa-clock me-1 text-success"></i>{{ form.office_open.label }}
                            </label>
                            {{ form.office_open }}
                            {% if form.office_open.errors %}
                            <div class="invalid-feedback d-block">
                                <i class="fas fa-exclamation-circle me-1"></i>{{ form.office_open.errors.0 }}
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="{{ form.maps.id_for_label }}" class="form-label fw-bold">
                                <i class="fas fa-map me-1 text-success"></i>{{ form.maps.label }}
                            </label>
                            {{ form.maps }}
                            {% if form.maps.errors %}
                            <div class="invalid-feedback d-block">
                                <i class="fas fa-exclamation-circle me-1"></i>{{ form.maps.errors.0 }}
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="{{ form.image.id_for_label }}" class="form-label fw-bold">
                                <i class="fas fa-image me-1 text-success"></i>{{ form.image.label }}
                            </label>
                            {{ form.image }}
                            {% if form.image.errors %}
                            <div class="invalid-feedback d-block">
                                <i class="fas fa-exclamation-circle me-1"></i>{{ form.image.errors.0 }}
                            </div>
                            {% endif %}
                            {% if branch and branch.image %}
                            <div class="mt-2">
                                <img src="{{ branch.image.url }}" alt="{{ branch.name }}" class="img-thumbnail border-dark" style="max-height: 100px;">
                                <small class="form-text text-muted d-block">
                                    Current branch image
                                </small>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Social Media Section -->
                <div class="row">
                    <div class="col-12">
                        <div class="card border-dark mb-4">
                            <div class="card-header bg-light border-dark">
                                <h6 class="card-title mb-0">
                                    <i class="fas fa-share-alt me-2 text-success"></i>Social Media Links
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="{{ form.facebook.id_for_label }}" class="form-label fw-bold">
                                                <i class="fab fa-facebook me-1 text-primary"></i>{{ form.facebook.label }}
                                            </label>
                                            {{ form.facebook }}
                                            <small class="form-text text-muted">
                                                <i class="fas fa-info-circle me-1"></i>{{ form.facebook.help_text }}
                                            </small>
                                            {% if form.facebook.errors %}
                                            <div class="invalid-feedback d-block">
                                                <i class="fas fa-exclamation-circle me-1"></i>{{ form.facebook.errors.0 }}
                                            </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="{{ form.twitter.id_for_label }}" class="form-label fw-bold">
                                                <i class="fab fa-twitter me-1 text-info"></i>{{ form.twitter.label }}
                                            </label>
                                            {{ form.twitter }}
                                            <small class="form-text text-muted">
                                                <i class="fas fa-info-circle me-1"></i>{{ form.twitter.help_text }}
                                            </small>
                                            {% if form.twitter.errors %}
                                            <div class="invalid-feedback d-block">
                                                <i class="fas fa-exclamation-circle me-1"></i>{{ form.twitter.errors.0 }}
                                            </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="{{ form.linkedin.id_for_label }}" class="form-label fw-bold">
                                                <i class="fab fa-linkedin me-1 text-primary"></i>{{ form.linkedin.label }}
                                            </label>
                                            {{ form.linkedin }}
                                            <small class="form-text text-muted">
                                                <i class="fas fa-info-circle me-1"></i>{{ form.linkedin.help_text }}
                                            </small>
                                            {% if form.linkedin.errors %}
                                            <div class="invalid-feedback d-block">
                                                <i class="fas fa-exclamation-circle me-1"></i>{{ form.linkedin.errors.0 }}
                                            </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="{{ form.instagram.id_for_label }}" class="form-label fw-bold">
                                                <i class="fab fa-instagram me-1 text-danger"></i>{{ form.instagram.label }}
                                            </label>
                                            {{ form.instagram }}
                                            <small class="form-text text-muted">
                                                <i class="fas fa-info-circle me-1"></i>{{ form.instagram.help_text }}
                                            </small>
                                            {% if form.instagram.errors %}
                                            <div class="invalid-feedback d-block">
                                                <i class="fas fa-exclamation-circle me-1"></i>{{ form.instagram.errors.0 }}
                                            </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-12">
                        <div class="mb-3">
                            <label for="{{ form.description.id_for_label }}" class="form-label fw-bold">
                                <i class="fas fa-file-alt me-1 text-success"></i>{{ form.description.label }}
                            </label>
                            {{ form.description }}
                            {% if form.description.errors %}
                            <div class="invalid-feedback d-block">
                                <i class="fas fa-exclamation-circle me-1"></i>{{ form.description.errors.0 }}
                            </div>
                            {% endif %}
                            <small class="form-text text-muted">
                                <i class="fas fa-info-circle me-1"></i>Use the toolbar above to format your description with rich text editing.
                            </small>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-12">
                        <div class="mb-3 form-check form-switch">
                            {{ form.status }}
                            <label class="form-check-label fw-bold" for="{{ form.status.id_for_label }}">
                                <i class="fas fa-power-off me-1 text-success"></i>{{ form.status.label }}
                            </label>
                            {% if form.status.errors %}
                            <div class="invalid-feedback d-block">
                                <i class="fas fa-exclamation-circle me-1"></i>{{ form.status.errors.0 }}
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-12">
                        <div class="d-flex gap-2">
                            <button type="submit" class="btn btn-success border-dark">
                                <i class="fas fa-save me-2"></i>Save Branch
                            </button>
                            <a href="{% url 'contact_app:branch_list' %}" class="btn btn-secondary border-dark">
                                <i class="fas fa-times me-2"></i>Cancel
                            </a>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<!-- Summernote CSS -->
<link href="https://cdn.jsdelivr.net/npm/summernote@0.8.18/dist/summernote-lite.min.css" rel="stylesheet">
<!-- Font Awesome for social media icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<style>
/* Summernote customization */
.note-editor {
    border: 2px solid #000 !important;
    border-radius: 0.375rem;
}

.note-editor .note-toolbar {
    background-color: #f8f9fa !important;
    border-bottom: 1px solid #000 !important;
    padding: 0.5rem !important;
}

.note-editor .note-btn {
    background: white !important;
    border: 1px solid #000 !important;
    color: #000 !important;
}

.note-editor .note-btn:hover {
    background-color: #7bf0bb !important;
}

.note-editor .note-editable {
    background-color: white !important;
    min-height: 200px !important;
    padding: 1rem !important;
}

.note-editor .note-statusbar {
    background-color: #f8f9fa !important;
    border-top: 1px solid #000 !important;
}

/* Form styling adjustments */
#id_description {
    display: none; /* Hide the original textarea as Summernote will replace it */
}

/* Social media card styling */
.social-media-card .card-header {
    background-color: #f8f9fa !important;
    border-bottom: 2px solid #000 !important;
}

/* Social media icon colors in form labels */
.fa-facebook {
    color: #1877f2 !important;
}

.fa-twitter {
    color: #1da1f2 !important;
}

.fa-linkedin {
    color: #0a66c2 !important;
}

.fa-instagram {
    color: #e4405f !important;
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .social-media-card .card-body .row > div {
        margin-bottom: 1rem;
    }
}
</style>
{% endblock %}

{% block extra_js %}
<!-- Summernote JS -->
<script src="https://cdn.jsdelivr.net/npm/summernote@0.8.18/dist/summernote-lite.min.js"></script>

<script>
$(document).ready(function() {
    // Add Bootstrap form validation classes
    $('input, select, textarea').addClass('form-control border-dark');
    $('input[type="checkbox"]').removeClass('form-control').addClass('form-check-input');
    $('input[type="file"]').removeClass('border-dark');
    
    // Initialize Summernote for description field
    $('#id_description').summernote({
        placeholder: 'Enter branch description...',
        tabsize: 2,
        height: 300,
        toolbar: [
            ['style', ['style']],
            ['font', ['bold', 'underline', 'clear']],
            ['fontname', ['fontname']],
            ['color', ['color']],
            ['para', ['ul', 'ol', 'paragraph']],
            ['table', ['table']],
            ['insert', ['link', 'picture', 'video']],
            ['view', ['fullscreen', 'codeview', 'help']]
        ],
        fontNames: ['Arial', 'Arial Black', 'Comic Sans MS', 'Courier New', 'Helvetica', 'Impact', 'Tahoma', 'Times New Roman', 'Verdana'],
        fontSizes: ['8', '9', '10', '11', '12', '14', '16', '18', '20', '24', '28', '32', '36'],
        callbacks: {
            onInit: function() {
                // Ensure the Summernote editor has proper borders
                $('.note-editor').css('border', '2px solid #000');
            },
            onChange: function(contents, $editable) {
                // Update the original textarea with Summernote content
                $('#id_description').val(contents);
            },
            onPaste: function(e) {
                // Clean up pasted content
                var bufferText = ((e.originalEvent || e).clipboardData || window.clipboardData).getData('Text');
                e.preventDefault();
                document.execCommand('insertText', false, bufferText);
            }
        }
    });

    // Initialize tooltips
    $('[data-bs-toggle="tooltip"]').tooltip();
    
    // Form validation
    $('.needs-validation').on('submit', function(event) {
        // Ensure Summernote content is synced before form submission
        var summernoteContent = $('#id_description').summernote('code');
        $('#id_description').val(summernoteContent);
        
        if (!this.checkValidity()) {
            event.preventDefault();
            event.stopPropagation();
        }
        $(this).addClass('was-validated');
    });

    // Handle form reset to clear Summernote
    $('button[type="reset"]').on('click', function() {
        $('#id_description').summernote('reset');
    });

    // Social media URL validation
    function validateSocialUrl(url, platform) {
        if (!url || url === '' || url.includes('https://www.' + platform.toLowerCase() + '.com/')) {
            return true; // Empty or default URLs are valid
        }
        
        const patterns = {
            'facebook': /^(https?:\/\/)?(www\.)?(facebook|fb)\.com\/.+/i,
            'twitter': /^(https?:\/\/)?(www\.)?(twitter|x)\.com\/.+/i,
            'linkedin': /^(https?:\/\/)?(www\.)?linkedin\.com\/.+/i,
            'instagram': /^(https?:\/\/)?(www\.)?instagram\.com\/.+/i
        };
        
        return patterns[platform].test(url);
    }

    // Add real-time validation for social media URLs
    $('#id_facebook, #id_twitter, #id_linkedin, #id_instagram').on('blur', function() {
        const field = $(this);
        const url = field.val();
        const platform = field.attr('id').replace('id_', '');
        
        if (url && !validateSocialUrl(url, platform)) {
            field.addClass('is-invalid');
            // Create or update error message
            let errorDiv = field.siblings('.social-url-error');
            if (errorDiv.length === 0) {
                errorDiv = $('<div class="invalid-feedback d-block social-url-error"></div>');
                field.after(errorDiv);
            }
            errorDiv.html('<i class="fas fa-exclamation-circle me-1"></i>Please enter a valid ' + platform + ' URL');
        } else {
            field.removeClass('is-invalid');
            field.siblings('.social-url-error').remove();
        }
    });

    // Ensure Summernote is properly initialized when navigating back to the page
    $(window).on('pageshow', function() {
        if ($('#id_description').length && !$('#id_description').siblings('.note-editor').length) {
            $('#id_description').summernote({
                placeholder: 'Enter branch description...',
                tabsize: 2,
                height: 300,
                toolbar: [
                    ['style', ['style']],
                    ['font', ['bold', 'underline', 'clear']],
                    ['fontname', ['fontname']],
                    ['color', ['color']],
                    ['para', ['ul', 'ol', 'paragraph']],
                    ['table', ['table']],
                    ['insert', ['link', 'picture', 'video']],
                    ['view', ['fullscreen', 'codeview', 'help']]
                ]
            });
        }
    });
});
</script>
{% endblock %}